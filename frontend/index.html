<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简道云数据同步系统</title>

    <!-- 添加网站图标 -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/vendor/index.css"/>
    <script src="/vendor/vue.global.js"></script>
    <script src="/vendor/icons-vue.iife.js"></script>
    <script src="/vendor/element-plus.full.js"></script>
    <script src="/vendor/zh-cn.min.js"></script>
    <script src="/vendor/vue-router.global.js"></script>
    <script src="/vendor/axios.min.js"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f4f4f5;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .login-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f5;
        }

        .login-card {
            width: 400px;
            padding: 40px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, .1);
            background-color: #fff;
            text-align: center;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 25px;
        }

        .login-card h2 {
            font-size: 18px;
            color: #606266;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #fff;
        }

        .full-height-container {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        .el-main {
            padding: 0;
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f4f4f5;
        }

        .el-header {
            background-color: #fff;
            color: #303133;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            flex-shrink: 0;
            border-bottom: 1px solid #e4e7ed;
        }

        .el-header h2 {
            font-size: 20px;
        }

        .el-menu {
            border-right: none;
        }

        .el-menu-item.is-active {
            background-color: #ecf5ff;
        }

        .config-card {
            margin: 20px;
        }

        .form-dialog .el-input, .form-dialog .el-select, .form-dialog .el-time-picker {
            width: 100%;
        }

        .form-dialog .el-form-item {
            margin-bottom: 15px;
        }

        .el-table .cell {
            white-space: pre-wrap;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .el-aside {
            flex-shrink: 0;
            background-color: #fff;
            border-right: 1px solid #eee;
            padding-top: 10px;
        }

        .log-filter-form {
            padding: 15px 0 0 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .log-filter-form .el-form-item {
            margin-bottom: 0;
        }

        .visibility-toggle-btn {
            margin-left: 8px;
        }

        .form-item-note {
            font-size: 12px;
            color: #909399;
            margin-top: -5px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
<div id="app">
    <el-config-provider :locale="zhCn">
        <template v-if="!isAuthenticated">
            <div class="login-container">
                <login-view @login-success="handleLoginSuccess"></login-view>
            </div>
        </template>
        <template v-else>
            <div class="app-container">
                <el-header height="60px">
                    <h2>数据同步配置</h2>
                    <div>
                        <span>你好, {{ username }} ({{ isSuperuser ? '超级管理员' : '租户: ' + departmentName }})</span>
                        <el-button type="danger" link @click="logout" style="margin-left: 15px;">退出登录</el-button>
                    </div>
                </el-header>
                <el-container class="full-height-container">
                    <el-aside width="200px">

                        <el-menu
                                :default-active="activeMenu"
                                router
                                :default-openeds="['user-management', 'system-management', 'task-management', 'log-management']"
                        >

                            <el-sub-menu index="user-management">
                                <template #title>
                                    <el-icon>
                                        <User/>
                                    </el-icon>
                                    <span>用户管理</span>
                                </template>
                                <el-menu-item index="/departments" v-if="isSuperuser">
                                    <!--<el-icon><OfficeBuilding/></el-icon>--> <!--不能正常显示-->
                                    <el-icon>
                                        <Memo/>
                                    </el-icon>
                                    <span>部门管理</span>
                                </el-menu-item>
                                <el-menu-item index="/users">
                                    <el-icon>
                                        <Avatar/>
                                    </el-icon>
                                    <span>用户列表</span>
                                </el-menu-item>
                            </el-sub-menu>

                            <el-sub-menu index="system-management">
                                <template #title>
                                    <el-icon>
                                        <Setting/>
                                    </el-icon>
                                    <span>系统管理</span>
                                </template>
                                <el-menu-item index="/jdy-keys">
                                    <el-icon>
                                        <Key/>
                                    </el-icon>
                                    <span>密钥管理</span>
                                </el-menu-item>
                                <el-menu-item index="/databases">
                                    <el-icon>
                                        <Coin/>
                                    </el-icon>
                                    <span>数据库管理</span>
                                </el-menu-item>
                            </el-sub-menu>

                            <el-sub-menu index="task-management">
                                <template #title>
                                    <el-icon>
                                        <Tickets/>
                                    </el-icon>
                                    <span>任务管理</span>
                                </template>
                                <el-menu-item index="/tasks-db-to-jdy">
                                    <el-icon>
                                        <Upload/>
                                    </el-icon>
                                    <span>数据库->简道云</span>
                                </el-menu-item>
                                <el-menu-item index="/tasks-jdy-to-db">
                                    <el-icon>
                                        <Download/>
                                    </el-icon>
                                    <span>简道云->数据库</span>
                                </el-menu-item>
                            </el-sub-menu>

                            <el-sub-menu index="log-management">
                                <template #title>
                                    <el-icon>
                                        <Document/>
                                    </el-icon>
                                    <span>日志管理</span>
                                </template>
                                <el-menu-item index="/logs-db-to-jdy">
                                    <el-icon>
                                        <Warning/>
                                    </el-icon>
                                    <span>数据库->简道云</span>
                                </el-menu-item>
                                <el-menu-item index="/logs-jdy-to-db">
                                    <el-icon>
                                        <Warning/>
                                    </el-icon>
                                    <span>简道云->数据库</span>
                                </el-menu-item>
                            </el-sub-menu>

                        </el-menu>
                    </el-aside>
                    <el-main>
                        <router-view
                                :is-superuser="isSuperuser"
                                :key="activeMenu"
                        ></router-view>
                    </el-main>
                </el-container>
            </div>
        </template>
    </el-config-provider>
</div>

<script>
    const ElementPlusIcons = window.ElementPlusIconsVue || {};
    const {createApp, ref, reactive, computed, onMounted, watch} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;
    const {useRoute, useRouter} = VueRouter;

    // --- 全局状态 ---
    // 用于在刷新时处理并发请求
    let isRefreshingToken = false;
    let failedRequestQueue = [];

    // --- Axios 实例 (适配 JWT Bearer Token) ---
    const apiClient = axios.create({
        baseURL: '/api' // 统一使用 /api 前缀
    });

    // 请求拦截器：自动附加 Bearer Token
    apiClient.interceptors.request.use(config => {
        const token = localStorage.getItem('access_token');
        if (token) {
            config.headers['Authorization'] = `Bearer ${token}`;
        }
        return config;
    });

    // 响应拦截器：处理 401 自动刷新
    apiClient.interceptors.response.use(
        response => response,
        async error => {
            const originalRequest = error.config;

            // 1. 如果是 401 错误，并且不是 /refresh 或 /login 失败
            if (error.response?.status === 401 && !originalRequest._retry) {
                if (originalRequest.url.endsWith('/login') || originalRequest.url.endsWith('/refresh')) {
                    // 登录或刷新失败，直接登出
                    window.appInstance?.handleLogout(true); // 强制登出
                    return Promise.reject(error.response?.data?.msg || '认证失败');
                }

                originalRequest._retry = true; // 标记为重试

                // 2. 处理并发的刷新请求
                if (isRefreshingToken) {
                    // 如果正在刷新，将失败的请求存入队列
                    return new Promise((resolve, reject) => {
                        failedRequestQueue.push({resolve, reject, config: originalRequest});
                    });
                }

                isRefreshingToken = true;
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    window.appInstance?.handleLogout(true);
                    return Promise.reject('无刷新令牌，请重新登录。');
                }

                try {
                    // 3. 尝试获取新 Token
                    const refreshResponse = await axios.post('/api/refresh', {}, {
                        headers: {'Authorization': `Bearer ${refreshToken}`}
                    });

                    const newAccessToken = refreshResponse.data.access_token;
                    localStorage.setItem('access_token', newAccessToken);

                    // 4. 更新当前请求的 Header 并重新发送
                    originalRequest.headers['Authorization'] = `Bearer ${newAccessToken}`;

                    // (重要) 处理队列中所有等待的请求
                    failedRequestQueue.forEach(req => {
                        req.config.headers['Authorization'] = `Bearer ${newAccessToken}`;
                        apiClient(req.config).then(req.resolve).catch(req.reject);
                    });
                    failedRequestQueue = [];

                    isRefreshingToken = false;
                    return apiClient(originalRequest); // 返回重试的原始请求

                } catch (refreshError) {
                    // 5. 刷新失败，登出
                    console.error("Token refresh failed:", refreshError);
                    window.appInstance?.handleLogout(true);
                    ElMessage.error('会话已过期，请重新登录。');
                    isRefreshingToken = false;
                    failedRequestQueue = [];
                    return Promise.reject(refreshError);
                }
            }

            // 处理其他错误
            if (error.response?.data?.error) {
                ElMessage.error(`操作失败: ${error.response.data.error}`);
            } else if (error.response?.data?.msg) {
                ElMessage.error(`操作失败: ${error.response.data.msg}`);
            } else if (error.message) {
                ElMessage.error(`请求错误: ${error.message}`);
            } else {
                ElMessage.error('发生未知错误');
            }
            return Promise.reject(error);
        }
    );

    // --- Reusable CRUD Composable ---
    function useCrud(apiEndpoint, itemName = '项目', defaultItem = {}, idKey = 'id') {
        const items = ref([]);
        const loading = ref(false);
        const dialogVisible = ref(false);
        const isEdit = ref(false);
        const currentItem = reactive({});
        const formRef = ref(null);

        const fetchItems = async () => {
            loading.value = true;
            try {
                // apiEndpoint 已经包含了 ?sync_type=...
                const response = await apiClient.get(apiEndpoint);
                items.value = response.data;
            } catch (error) {
                console.error(`获取 ${itemName} 列表失败:`, error);
                // 错误已由拦截器显示
            } finally {
                loading.value = false;
            }
        };

        const openDialog = (item = null) => {
            if (item) {
                isEdit.value = true;
                // 编辑时，从列表复制数据
                let itemData = JSON.parse(JSON.stringify(item));

                Object.assign(currentItem, itemData);

                // 统一清空所有敏感字段，使其在编辑时显示 placeholder
                // (用户密码、数据库密码、JDY Key、JDY Secret)
                if ('password' in currentItem) {
                    currentItem.password = '';
                }
                if ('db_password' in currentItem) {
                    currentItem.db_password = '';
                }
                if ('api_key' in currentItem) {
                    currentItem.api_key = '';
                }
                if ('api_secret' in currentItem) {
                    // 仅当 api_secret 存在时才清空
                    // (jdy2db 任务列表可能没有 api_secret,
                    // 但上面的占位符逻辑已经将其设置为空字符串)
                    currentItem.api_secret = '';
                }

            } else {
                isEdit.value = false;
                Object.keys(currentItem).forEach(key => delete currentItem[key]);
                Object.assign(currentItem, JSON.parse(JSON.stringify(defaultItem)));
            }
            dialogVisible.value = true;
            Vue.nextTick(() => {
                if (formRef.value) formRef.value.clearValidate();
            });
        };

        const closeDialog = () => {
            dialogVisible.value = false;
        };

        const saveItem = async () => {
            if (!formRef.value) return;
            try {
                await formRef.value.validate();
            } catch (error) {
                ElMessage.warning('请检查表单输入。');
                return;
            }

            loading.value = true;
            // 从 apiEndpoint 中移除查询参数
            const baseUrl = apiEndpoint.split('?')[0];
            const url = isEdit.value ? `${baseUrl}/${currentItem[idKey]}` : baseUrl;
            const method = isEdit.value ? 'put' : 'post';

            try {
                const dataToSend = {...currentItem};

                // 清理前端临时字段
                if ('full_sync_time_temp' in dataToSend) {
                    dataToSend.full_sync_time = dataToSend.full_sync_time_temp || null;
                    delete dataToSend.full_sync_time_temp;
                }
                if ('daily_sync_time_temp' in dataToSend) {
                    dataToSend.daily_sync_time = dataToSend.daily_sync_time_temp || null;
                    delete dataToSend.daily_sync_time_temp;
                }

                // 清理所有敏感字段
                // 如果是编辑 (put)，且字段为空(falsy, e.g., '')，则不发送该字段
                // (后端逻辑是 'field' in data 才会触发更新)
                if (method === 'put') {
                    if ('password' in dataToSend && !dataToSend.password) {
                        delete dataToSend.password;
                    }
                    if ('db_password' in dataToSend && !dataToSend.db_password) {
                        delete dataToSend.db_password;
                    }
                    if ('api_key' in dataToSend && !dataToSend.api_key) {
                        delete dataToSend.api_key;
                    }
                    if ('api_secret' in dataToSend && !dataToSend.api_secret) {
                        delete dataToSend.api_secret;
                    }
                }

                // 清理只读字段
                delete dataToSend.created_at;
                delete dataToSend.updated_at;
                // 清理只读的 webhook_url
                delete dataToSend.webhook_url;

                // 清理上次同步时间，防止前端提交此只读字段
                delete dataToSend.last_sync_time;

                const response = await apiClient[method](url, dataToSend);

                if (isEdit.value) {
                    const index = items.value.findIndex(i => i[idKey] === currentItem[idKey]);
                    if (index !== -1) items.value.splice(index, 1, response.data);
                } else {
                    items.value.push(response.data);
                }
                closeDialog();
                ElMessage.success(`${itemName} 保存成功！`);
            } catch (error) {
                console.error(`保存 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };

        const deleteItem = async (id) => {
            try {
                await ElMessageBox.confirm(`确定要删除这个 ${itemName} (ID: ${id}) 吗?`, '警告', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                });
                loading.value = true;
                // 从 apiEndpoint 中移除查询参数
                const baseUrl = apiEndpoint.split('?')[0];
                await apiClient.delete(`${baseUrl}/${id}`);
                items.value = items.value.filter(i => i[idKey] !== id);
                ElMessage.success(`${itemName} 删除成功！`);
            } catch (error) {
                if (error !== 'cancel') console.error(`删除 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };
        onMounted(fetchItems);
        return {
            items,
            loading,
            dialogVisible,
            isEdit,
            currentItem,
            formRef,
            fetchItems,
            openDialog,
            closeDialog,
            saveItem,
            deleteItem
        };
    }

    // --- Login Component (适配 /api/login 和 JWT) ---
    const LoginView = {
        template: `
          <el-card class="login-card">
            <h1 class="login-title">简道云数据同步系统</h1>
            <h2>登录</h2>
            <el-form @submit.prevent="submitLogin" ref="loginFormRef" :model="loginForm" :rules="loginRules"
                     label-position="top">
              <el-form-item label="用户名" prop="username">
                <el-input v-model="loginForm.username" placeholder="请输入用户名"></el-input>
              </el-form-item>
              <el-form-item label="密码" prop="password">
                <el-input type="password" v-model="loginForm.password" placeholder="请输入密码"
                          show-password></el-input>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" native-type="submit" :loading="loading" style="width: 100%;">登录</el-button>
              </el-form-item>
            </el-form>
          </el-card>
        `,
        emits: ['login-success'],
        setup(props, {emit}) {
            const loginForm = reactive({username: '', password: ''});
            const loading = ref(false);
            const loginFormRef = ref(null);
            const loginRules = {
                username: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: true, message: '请输入密码', trigger: 'blur'}],
            };
            const submitLogin = async () => {
                if (!loginFormRef.value) return;
                try {
                    await loginFormRef.value.validate();
                } catch (error) {
                    return;
                }
                loading.value = true;
                try {
                    // 使用 axios.post 访问 /api/login
                    const response = await axios.post('/api/login', loginForm);
                    const data = response.data;

                    // 存储所有 Token 和用户信息
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('is_superuser', data.is_superuser);
                    // 存储 department_id
                    localStorage.setItem('department_id', data.department_id);
                    localStorage.setItem('department_name', data.department_name || 'N/A');

                    emit('login-success', data); // 传递所有用户数据
                    ElMessage.success('登录成功!');
                } catch (error) {
                    console.error("登录失败:", error);
                    // 显示后端错误
                    const msg = error.response?.data?.msg || '登录失败，请检查用户名或密码';
                    ElMessage.error(msg);
                } finally {
                    loading.value = false;
                }
            };
            return {loginForm, loading, loginFormRef, loginRules, submitLogin};
        }
    };

    // --- Department Component ---
    const DepartmentView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>部门管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加部门</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="部门ID" width="200" sortable></el-table-column>
              <el-table-column prop="department_name" label="部门简称 (英文)" sortable></el-table-column>
              <el-table-column prop="department_full_name" label="部门全称" sortable></el-table-column>
              <el-table-column prop="is_active" label="是否激活" width="200">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="200" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑部门' : '添加部门'" width="500px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <!--<el-form-item label="部门ID (外部)" prop="id">
                  <el-input v-model.number="currentItem.id" placeholder="唯一的数字ID" :disabled="isEdit"></el-input>
                </el-form-item>-->
                <el-form-item label="部门简称 (英文)" prop="department_name">
                  <el-input v-model="currentItem.department_name" placeholder="例如：sales_dept (唯一)"></el-input>
                </el-form-item>
                <el-form-item label="部门全称" prop="department_name">
                  <el-input v-model="currentItem.department_full_name" placeholder="例如：销售部门"></el-input>
                </el-form-item>
                <el-form-item label="是否激活">
                  <el-switch v-model="currentItem.is_active"></el-switch>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        setup() {
            const defaultItem = {id: null, department_name: '', department_full_name: '', is_active: true};
            // 3.2 - API endpoint is /departments
            const crud = useCrud('/departments', '部门', defaultItem, 'id');
            const formRules = {
                // id: [{required: true, message: '请输入部门ID', trigger: 'blur'}],
                department_name: [{required: true, message: '请输入部门简称(英文)', trigger: 'blur'}],
                department_full_name: [{required: true, message: '请输入部门全称', trigger: 'blur'}],
            };
            return {...crud, formRules, ElementPlusIcons};
        }
    };

    // --- User Component ---
    const UserView = {
        props: ['isSuperuser'], // <-- ADDED PROPS
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>用户列表</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus" v-if="isSuperuser">
                  添加用户
                </el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="100" sortable></el-table-column>
              <el-table-column prop="username" label="用户名" sortable></el-table-column>
              <el-table-column prop="department_name" label="所属部门" sortable></el-table-column>
              <el-table-column prop="is_superuser" label="超级管理员" width="200">
                <template #default="scope">
                  <el-tag :type="scope.row.is_superuser ? 'danger' : 'info'">
                    {{ scope.row.is_superuser ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="is_active" label="是否激活" width="200">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="300" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openResetPassword(scope.row)" :icon="ElementPlusIcons.RefreshLeft">
                    重置密码
                  </el-button>
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit"
                             v-if="isSuperuser">编辑
                  </el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete" v-if="isSuperuser">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑用户' : '添加用户'" width="500px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <el-form-item label="用户名" prop="username">
                  <el-input v-model="currentItem.username" placeholder="登录用户名"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password" v-if="!isEdit">
                  <el-input type="password" v-model="currentItem.password" placeholder="新增时必填"
                            show-password></el-input>
                </el-form-item>
                <el-form-item label="所属部门" prop="department_id">
                  <el-select v-model="currentItem.department_id" placeholder="选择所属部门">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name"
                               :value="dept.id"></el-option>
                  </el-select>
                </el-form-item>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="超级管理员">
                      <el-switch v-model="currentItem.is_superuser"></el-switch>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="是否激活">
                      <el-switch v-model="currentItem.is_active"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>

            <el-dialog v-model="resetPasswordDialogVisible" title="重置密码" width="400px" class="form-dialog">
              <el-form ref="resetFormRef" :model="resetPasswordData" :rules="resetPasswordRules" label-position="top">
                <p>正在为用户 <strong>{{ currentItem.username }}</strong> 重置密码。</p>
                <el-form-item label="旧密码" prop="old_password">
                  <el-input type="password" v-model="resetPasswordData.old_password" placeholder="请输入旧密码"
                            show-password></el-input>
                </el-form-item>
                <el-form-item label="新密码" prop="new_password">
                  <el-input type="password" v-model="resetPasswordData.new_password" placeholder="请输入新密码"
                            show-password></el-input>
                </el-form-item>
                <el-form-item label="确认新密码" prop="confirm_new_password">
                  <el-input type="password" v-model="resetPasswordData.confirm_new_password"
                            placeholder="请再次输入新密码"
                            show-password></el-input>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="resetPasswordDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitResetPassword" :loading="loading">确认重置</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            const defaultItem = {username: '', password: '', department_id: null, is_superuser: false, is_active: true};
            const crud = useCrud('/users', '用户', defaultItem, 'id');
            const departments = ref([]);
            const resetPasswordDialogVisible = ref(false);

            // --- 初始化 resetPasswordData ---
            const resetPasswordData = reactive({
                old_password: '',
                new_password: '',
                confirm_new_password: ''
            });
            const resetFormRef = ref(null);

            const formRules = computed(() => ({
                username: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: !crud.isEdit.value, message: '请输入密码', trigger: 'blur'}],
                department_id: [{required: true, message: '请选择部门', trigger: 'change'}],
            }));

            // 自定义验证器：检查两次密码是否一致
            const validateConfirmPassword = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请再次输入新密码'));
                } else if (value !== resetPasswordData.new_password) {
                    callback(new Error('两次输入的新密码不一致'));
                } else {
                    callback();
                }
            };

            const resetPasswordRules = computed(() => ({
                old_password: [{required: true, message: '请输入旧密码', trigger: 'blur'}],
                new_password: [
                    {required: true, message: '请输入新密码', trigger: 'blur'},
                    // 当新密码输入框变化时，触发确认密码框的验证
                    {
                        validator: (rule, value, callback) => {
                            if (resetPasswordData.confirm_new_password) {
                                resetFormRef.value.validateField('confirm_new_password');
                            }
                            callback();
                        }, trigger: 'blur'
                    }
                ],
                confirm_new_password: [
                    {required: true, message: '请再次输入新密码', trigger: 'blur'},
                    {validator: validateConfirmPassword, trigger: 'blur'}
                ],
            }));
            // --- 结束修改点 2 ---

            const fetchDepartments = async () => {
                // ADDED: Only fetch depts if superuser
                if (props.isSuperuser) {
                    try {
                        departments.value = (await apiClient.get('/departments')).data;
                    } catch (e) {
                        console.error(e);
                    }
                }
            };

            // --- 清空所有字段 ---
            const openResetPassword = (user) => {
                Object.assign(crud.currentItem, user); // 锁定当前用户
                resetPasswordData.old_password = '';
                resetPasswordData.new_password = '';
                resetPasswordData.confirm_new_password = ''; // 清空确认密码
                resetPasswordDialogVisible.value = true;
                Vue.nextTick(() => resetFormRef.value?.clearValidate());
            };

            // --- 提交时仅发送需要的数据 ---
            const submitResetPassword = async () => {
                if (!resetFormRef.value) return;
                try {
                    await resetFormRef.value.validate();
                } catch (e) {
                    return;
                }

                crud.loading.value = true;
                try {
                    // 仅发送后端需要的 old_password 和 new_password
                    const dataToSend = {
                        old_password: resetPasswordData.old_password,
                        new_password: resetPasswordData.new_password
                    };

                    await apiClient.patch(`/users/${crud.currentItem.id}/reset-password`, dataToSend);
                    ElMessage.success(`用户 ${crud.currentItem.username} 的密码重置成功！`);
                    resetPasswordDialogVisible.value = false;
                } catch (error) {
                    console.error("重置密码失败:", error);
                    // The error will be shown by the interceptor
                } finally {
                    crud.loading.value = false;
                }
            };

            onMounted(fetchDepartments);
            // 非超管只能看自己
            watch(() => props.isSuperuser, (newVal) => {
                if (!newVal) {
                    const currentUsername = localStorage.getItem('username');
                    crud.items.value = crud.items.value.filter(u => u.username === currentUsername);
                }
            }, {immediate: true});


            return {
                ...crud,
                formRules,
                departments,
                resetPasswordDialogVisible,
                resetPasswordData,
                resetFormRef,
                resetPasswordRules,
                openResetPassword,
                submitResetPassword,
                ElementPlusIcons
            };
        }
    };

    // --- Database Component ---
    const DatabaseView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>数据库管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加数据库</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="60" sortable></el-table-column>
              <el-table-column v-if="isSuperuser" prop="department_name" label="所属部门" width="200"
                               sortable></el-table-column>
              <el-table-column prop="db_show_name" label="显示名称" sortable></el-table-column>

              <el-table-column prop="sync_type" label="同步类型" width="160">
                <template #default="scope">
                  <el-tag :type="scope.row.sync_type === 'jdy2db' ? 'success' : 'primary'">
                    {{ scope.row.sync_type === 'jdy2db' ? '简道云->数据库' : '数据库->简道云' }}
                  </el-tag>
                </template>
              </el-table-column>

              <el-table-column prop="db_type" label="类型" width="120"></el-table-column>
              <el-table-column prop="db_host" label="主机"></el-table-column>
              <el-table-column prop="db_port" label="端口" width="80"></el-table-column>
              <el-table-column prop="db_name" label="库名"></el-table-column>
              <el-table-column prop="db_user" label="用户"></el-table-column>
              <el-table-column prop="is_active" label="激活" width="80">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="200" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑数据库' : '添加数据库'" width="600px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <el-form-item label="所属部门" prop="department_id" v-if="isSuperuser">
                  <el-select v-model="currentItem.department_id" placeholder="选择所属部门">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name"
                               :value="dept.id"></el-option>
                  </el-select>
                </el-form-item>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="显示名称" prop="db_show_name">
                      <el-input v-model="currentItem.db_show_name" placeholder="例如：生产库"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="同步类型" prop="sync_type">
                      <el-select v-model="currentItem.sync_type" placeholder="选择此数据库的用途" :disabled="isEdit">
                        <el-option label="数据库 -> 简道云" value="db2jdy"></el-option>
                        <el-option label="简道云 -> 数据库" value="jdy2db"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="数据库类型" prop="db_type">
                      <el-select v-model="currentItem.db_type" placeholder="选择数据库类型">
                        <el-option label="MySQL" value="MySQL"></el-option>
                        <el-option label="PostgreSQL" value="PostgreSQL"></el-option>
                        <el-option label="SQL Server" value="SQL Server"></el-option>
                        <el-option label="Oracle" value="Oracle"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="主机" prop="db_host">
                      <el-input v-model="currentItem.db_host" placeholder="localhost 或 IP"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="端口" prop="db_port">
                      <el-input-number v-model.number="currentItem.db_port" :min="1" :max="65535"
                                       style="width: 100%;"></el-input-number>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="数据库名称" prop="db_name">
                      <el-input v-model="currentItem.db_name"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="用户名" prop="db_user">
                      <el-input v-model="currentItem.db_user"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="密码" prop="db_password">
                      <el-input type="password"
                      v-model="currentItem.db_password"
                      :placeholder="isEdit ? '***************************' : '请输入密码'" show-password></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-form-item label="额外连接参数 (选填)" prop="db_args">
                  <el-input v-model="currentItem.db_args" placeholder="例如: charset=utf8mb4"></el-input>
                  <!--<div class="form-item-note">例如: MySQL 可填 charset=utf8mb4。 SQL Server (mssql) 可能需要填: driver=ODBC+Driver+17+for+SQL+Server</div>-->
                </el-form-item>
                <el-form-item label="是否激活">
                  <el-switch v-model="currentItem.is_active"></el-switch>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button @click="testConnection" :loading="testLoading" :icon="ElementPlusIcons.Connection">测试连接
                </el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            const defaultItem = {
                db_show_name: '',
                sync_type: 'db2jdy',
                db_type: 'MySQL',
                db_host: 'localhost',
                db_port: 3306,
                db_name: '',
                db_user: '',
                db_password: '',
                is_active: true,
                department_id: null,
                db_args: ''
            };
            // 3.2 - API endpoint is /databases
            const crud = useCrud('/databases', '数据库', defaultItem, 'id');
            const departments = ref([]);
            // 测试连接的加载状态
            const testLoading = ref(false);

            const formRules = computed(() => ({
                department_id: [{required: props.isSuperuser, message: '请选择部门', trigger: 'change'}],
                db_show_name: [{required: true, message: '请输入显示名称', trigger: 'blur'}],
                sync_type: [{required: true, message: '请选择同步类型', trigger: 'change'}], // 3.6
                db_type: [{required: true, message: '请选择类型', trigger: 'change'}],
                db_host: [{required: true, message: '请输入主机', trigger: 'blur'}],
                db_port: [{required: true, message: '请输入端口', trigger: 'blur'}],
                db_name: [{required: true, message: '请输入库名', trigger: 'blur'}],
                db_user: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                db_password: [{required: !crud.isEdit.value, message: '请输入密码', trigger: 'blur'}],
            }));

            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try {
                        departments.value = (await apiClient.get('/departments')).data;
                    } catch (e) {
                        console.error(e);
                    }
                }
            };

            // 测试连接方法
            const testConnection = async () => {
                if (!crud.formRef.value) return;
                try {
                    // 验证表单以确保数据存在
                    await crud.formRef.value.validate();
                } catch (error) {
                    ElMessage.warning('请先填写完整的数据库连接信息。');
                    return;
                }

                testLoading.value = true;
                try {
                    const response = await apiClient.post('/databases/test', crud.currentItem);

                    if (response.status === 200) {
                        ElMessage.success(`测试成功: ${response.data.msg}`);
                    }

                } catch (error) {
                    console.error("测试连接请求失败:", error);
                    // 如果错误是 400 (Bad Request)，拦截器已经显示了 msg
                    if (error.response?.status !== 400) {
                        ElMessage.error('测试连接时发生未知错误。');
                    }
                } finally {
                    testLoading.value = false;
                }
            };

            onMounted(fetchDepartments);

            // 返回新状态和新方法
            return {...crud, formRules, departments, testLoading, testConnection, ElementPlusIcons};
        }
    };

    // --- JdyKeyInfo Component (适配多租户) ---
    const JdyKeyInfoView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>简道云密钥管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加密钥</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="200"></el-table-column>
              <el-table-column prop="department_name" label="所属部门名称" v-if="isSuperuser"
                               sortable></el-table-column>

              <el-table-column label="API Key">
                <template #default="scope"> <span>***************************</span> </template>
                <!--<template #default="scope"> {{ scope.row.api_key ? scope.row.api_key.substring(0, 10) : '' }}...
                </template>-->
              </el-table-column>
              <!--<el-table-column label="API Secret">
                <template #default="scope"> {{ scope.row.api_secret ? scope.row.api_secret.substring(0, 10) : '' }}...
                </template>
              </el-table-column>-->
              <el-table-column label="API 描述">
                <template #default="scope"> {{ scope.row.description ? scope.row.description : '' }}
                </template>
              </el-table-column>
              <el-table-column label="操作" width="200" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑密钥' : '添加密钥'" width="500px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="keyRules" label-position="top">
                <el-form-item label="所属部门" prop="department_id" v-if="isSuperuser">
                  <el-select v-model="currentItem.department_id" placeholder="选择所属部门 (1:1 关系)">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name"
                               :value="dept.id"></el-option>
                  </el-select>
                </el-form-item>

                <el-form-item label="API Key" prop="api_key">
                  <!--<el-input v-model="currentItem.api_key" placeholder="请输入简道云 API Key"></el-input>-->
                  <el-input
                    type="password"
                    v-model="currentItem.api_key"
                    :placeholder="isEdit ? '***************************' : '请输入简道云 API Key'"
                    show-password>
                  </el-input>
                </el-form-item>
                <!--<el-form-item label="API Secret" prop="api_secret">
                  <el-input v-model="currentItem.api_secret"
                            placeholder="简道云 API Secret，用于接收简道云数据推送，可置空"></el-input>
                </el-form-item>-->
                <el-form-item label="API 描述" prop="description">
                  <el-input v-model="currentItem.description"
                            placeholder="简道云 API 描述"></el-input>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            const defaultItem = {department_id: null, api_key: '', description: ''};
            const crud = useCrud('/jdy-keys', '密钥', defaultItem, 'id');
            const departments = ref([]);

            // --- *** 仅在"添加"时将 api_key 设为必填 *** ---
            const keyRules = computed(() => ({
                department_id: [{required: props.isSuperuser, message: '请选择部门', trigger: 'change'}],
                // api_key: [{required: true, message: '请输入 API Key', trigger: 'blur'}],
                // 仅在 !isEdit (即创建时) 设为必填
                api_key: [{required: !crud.isEdit.value, message: '请输入 API Key', trigger: 'blur'}],
                // api_secret: [{required: false, message: '请输入 API Secret', trigger: 'blur'}],
                description: [{required: false, message: '请添加 API描述', trigger: 'blur'}],
            }));

            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try {
                        departments.value = (await apiClient.get('/departments')).data;
                    } catch (e) {
                        console.error(e);
                    }
                }
            };
            onMounted(fetchDepartments);

            // --- *** 在打开编辑对话框时，确保 api_key 字段为空 *** ---
            watch(() => crud.dialogVisible.value, (newVal) => {
                if (newVal && crud.isEdit.value) {
                    // 确保在编辑时，api_key 字段被清空，以显示 "如需修改..." 的 placeholder
                    crud.currentItem.api_key = '';
                }
            });

            return {...crud, keyRules, departments, ElementPlusIcons};
        }
    };

    // --- SyncTask Component (适配多租户) ---
    const SyncTaskViewDbToJdy = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>数据库 -> 简道云 同步任务管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加任务</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%" row-key="id">
              <el-table-column prop="id" label="ID" width="60"></el-table-column>
              <el-table-column v-if="isSuperuser" prop="department_name" label="所属部门" width="180"
                               sortable></el-table-column>
              <el-table-column prop="task_name" label="任务名称" sortable></el-table-column>
              <el-table-column prop="db_show_name" label="源数据库" sortable>
                <template #default="scope">
                  <el-tag>{{ scope.row.db_show_name || 'N/A' }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="table_name" label="源表名" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID"></el-table-column>
              <el-table-column prop="sync_mode" label="同步模式" width="150"></el-table-column>
              <el-table-column prop="is_active" label="激活" width="70">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="sync_status" label="运行状态" width="100">
                <template #default="scope">
                  <el-tag :type="statusType(scope.row.sync_status)"> {{ scope.row.sync_status }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="last_sync_time" label="上次同步时间" width="170">
                <template #default="scope">{{ formatDateTime(scope.row.last_sync_time) }}</template>
              </el-table-column>
              <el-table-column label="操作" width="200" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑任务' : '添加任务'" width="700px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="taskRules" label-position="top" label-width="150px">

                <input type="hidden" v-model="currentItem.sync_type"/>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="任务名称" prop="task_name">
                      <el-input v-model="currentItem.task_name" placeholder="例如：销售订单同步"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="所属部门 (租户)" prop="department_id" v-if="isSuperuser">
                      <el-select v-model="currentItem.department_id" placeholder="选择所属部门"
                                 @change="onDepartmentChange">
                        <el-option v-for="dept in departments" :key="dept.id"
                                   :label="dept.department_name" :value="dept.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="源数据库" prop="database_id">
                      <el-select v-model="currentItem.database_id" placeholder="选择源数据库">
                        <el-option v-for="db in filteredDatabases" :key="db.id"
                                   :label="db.db_show_name" :value="db.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="源数据库表名" prop="table_name">
                      <el-input v-model="currentItem.table_name" placeholder="数据库中的表名或视图名"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="简道云 App ID" prop="app_id">
                      <el-input v-model="currentItem.app_id"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="简道云 Entry ID" prop="entry_id">
                      <el-input v-model="currentItem.entry_id"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-divider>同步模式配置</el-divider>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="同步模式" prop="sync_mode">
                      <el-select v-model="currentItem.sync_mode" placeholder="选择同步模式">
                        <el-option label="INCREMENTAL (增量)" value="INCREMENTAL"></el-option>
                        <el-option label="FULL_SYNC (全量)" value="FULL_SYNC"></el-option>
                        <el-option label="BINLOG (实时)" value="BINLOG"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="任务激活">
                      <el-switch v-model="currentItem.is_active"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>

                <template
                    v-if="currentItem.sync_mode === 'FULL_SYNC' || currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'BINLOG'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="源表主键" prop="business_keys">
                        <el-input v-model="currentItem.business_keys"
                                  placeholder="e.g., id1,id2 (复合主键用英文逗号分隔)"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="增量时间字段" prop="incremental_field">
                        <el-input v-model="currentItem.incremental_field"
                                  placeholder="e.g., last_modified_time"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="增量间隔 (分钟)" prop="incremental_interval">
                        <el-input-number v-model="currentItem.incremental_interval" :min="1"
                                         style="width: 100%;"></el-input-number>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template
                    v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'BINLOG'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="首次执行全量同步">
                        <el-switch v-model="currentItem.is_full_sync_first"></el-switch>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12" v-if="currentItem.is_full_sync_first">
                      <el-form-item label="⚠️首次全量同步时，执行清空目标表操作">
                        <el-switch v-model="currentItem.is_delete_first"></el-switch>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'FULL_SYNC'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="每日同步时间" prop="full_sync_time">
                        <el-time-picker v-model="currentItem.full_sync_time_temp" format="HH:mm"
                                        value-format="HH:mm:ss"
                                        placeholder="选择时间"></el-time-picker>
                      </el-form-item>
                      <!--默认就是True-->
                      <!--<el-form-item label="首次执行全量同步">
                        <el-switch v-model="currentItem.is_full_sync_first"></el-switch>
                      </el-form-item>-->
                      <el-form-item label="⚠️首次全量同步时，执行清空目标表操作">
                        <el-switch v-model="currentItem.is_delete_first"></el-switch>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'FULL_SYNC'">
                  <el-form-item label="SQL 过滤条件 (选填)" prop="source_filter_sql">
                    <el-input type="textarea" v-model="currentItem.source_filter_sql"
                              placeholder="e.g., status = 'approved' AND amount > 1000"></el-input>
                  </el-form-item>
                </template>

                <el-divider>通知配置</el-divider>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="发送企微错误日志">
                      <el-switch v-model="currentItem.send_error_log_to_wecom"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-form-item label="企微机器人 Webhook URL" prop="wecom_robot_webhook_url"
                              v-if="currentItem.send_error_log_to_wecom">
                  <el-input type="textarea" v-model="currentItem.wecom_robot_webhook_url"
                            placeholder="如果打开了企微错误通知，请粘贴机器人 URL"></el-input>
                </el-form-item>

              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // 适配 SyncTask 模型的字段
            const defaultTask = {
                task_name: '',
                department_id: null,
                database_id: null,
                table_name: '',
                business_keys: '',
                app_id: '',
                entry_id: '',
                sync_mode: 'INCREMENTAL',
                is_active: true,
                incremental_field: '',
                incremental_interval: 5,
                full_sync_time_temp: null,
                full_sync_time: null,
                source_filter_sql: null,
                is_full_sync_first: false,
                is_delete_first: false,
                send_error_log_to_wecom: false,
                wecom_robot_webhook_url: null,
                sync_type: 'db2jdy'
            };

            // 3.6 - Fix API endpoint
            const crud = useCrud('/sync-tasks?sync_type=db2jdy', '同步任务', defaultTask, 'id');
            const departments = ref([]);
            const allDatabases = ref([]);

            // 计算属性，用于根据选择的部门过滤数据库下拉框
            const filteredDatabases = computed(() => {
                // 过滤出 sync_type = 'db2jdy' 的数据库
                let dbs = allDatabases.value.filter(db => db.sync_type === 'db2jdy');
                if (props.isSuperuser) {
                    if (!crud.currentItem.department_id) return [];
                    return dbs.filter(db => db.department_id === crud.currentItem.department_id);
                }
                return dbs; // 非超管，allDatabases 本身就是过滤过的
            });

            // 动态验证规则
            const validatePkField = (rule, value, callback) => {
                if (crud.currentItem.sync_mode !== 'FULL_SYNC' && !value) {
                    callback(new Error('请输入源表主键'));
                } else {
                    callback();
                }
            };

            // 规则: FULL_SYNC 模式需要指定 全量同步时间
            const validateFullReplaceTime = (rule, value, callback) => {
                // 注意: 验证器是为 'full_sync_time' 注册的，但检查 'full_sync_time_temp'
                if (crud.currentItem.sync_mode === 'FULL_SYNC' && !crud.currentItem.full_sync_time_temp) {
                    callback(new Error('请选择每日同步时间'));
                } else {
                    callback();
                }
            };

            // 规则: INCREMENTAL 模式需要 增量时间字段
            const validateIncrementalField = (rule, value, callback) => {
                if (crud.currentItem.sync_mode === 'INCREMENTAL' && !value) {
                    callback(new Error('请输入增量时间字段'));
                } else {
                    callback();
                }
            };

            // 规则: INCREMENTAL 模式需要 增量同步时间间隔
            const validateIncrementalInterval = (rule, value, callback) => {
                if (crud.currentItem.sync_mode === 'INCREMENTAL' && !value) {
                    callback(new Error('请输入增量间隔'));
                } else {
                    callback();
                }
            };

            const taskRules = computed(() => ({
                task_name: [{required: true, message: '请输入任务名称', trigger: 'blur'}],
                department_id: [{required: props.isSuperuser, message: '请选择所属部门', trigger: 'change'}],
                database_id: [{required: true, message: '请选择源数据库', trigger: 'change'}],
                table_name: [{required: true, message: '请输入源表名', trigger: 'blur'}],
                app_id: [{required: true, message: '请输入 App ID', trigger: 'blur'}],
                entry_id: [{required: true, message: '请输入 Entry ID', trigger: 'blur'}],
                business_keys: [{validator: validatePkField, trigger: 'blur'}],
                full_sync_time: [{validator: validateFullReplaceTime, trigger: 'change'}],
                incremental_field: [{validator: validateIncrementalField, trigger: 'blur'}],
                incremental_interval: [{validator: validateIncrementalInterval, trigger: 'change'}],
            }));

            const onDepartmentChange = () => {
                // 管理员切换部门时，清空已选的数据库
                if (props.isSuperuser) {
                    crud.currentItem.database_id = null;
                }
            };

            // 获取部门 (仅管理员)
            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try {
                        departments.value = (await apiClient.get('/departments')).data;
                    } catch (e) {
                        console.error(e);
                    }
                }
            };
            const fetchAllDatabases = async () => {
                try {
                    // 获取所有数据库，然后在前端过滤
                    allDatabases.value = (await apiClient.get('/databases')).data;
                } catch (error) {
                    console.error("获取数据库列表失败:", error);
                }
            };

            // const taskRules = {
            //     task_name: [{required: true, message: '请输入任务名称', trigger: 'blur'}],
            //     department_id: [{required: props.isSuperuser, message: '请选择所属部门', trigger: 'change'}],
            //     database_id: [{required: true, message: '请选择源数据库', trigger: 'change'}],
            //     table_name: [{required: true, message: '请输入源表名', trigger: 'blur'}],
            //     app_id: [{required: true, message: '请输入 App ID', trigger: 'blur'}],
            //     entry_id: [{required: true, message: '请输入 Entry ID', trigger: 'blur'}],
            //
            //     // 应用新的自定义验证器
            //     business_keys: [{validator: validatePkField, trigger: 'blur'}],
            //     full_sync_time: [{validator: validateFullReplaceTime, trigger: 'change'}],
            //     incremental_field: [{validator: validateIncrementalField, trigger: 'blur'}],
            //     incremental_interval: [{validator: validateIncrementalInterval, trigger: 'change'}],
            // };

            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const statusType = (status) => status === 'running' ? 'primary' : (status === 'error' ? 'danger' : 'info');

            watch(() => crud.dialogVisible.value, (newVal) => {
                if (newVal) {
                    fetchAllDatabases();
                    if (props.isSuperuser) fetchDepartments();

                    // 处理时间回显
                    if (crud.isEdit.value && crud.currentItem.full_sync_time) {
                        crud.currentItem.full_sync_time_temp = crud.currentItem.full_sync_time;
                    } else if (newVal && !crud.isEdit.value) {
                        crud.currentItem.full_sync_time_temp = null;
                        // 非管理员自动设置部门ID
                        if (!props.isSuperuser) {
                            // 确保 department_id 是数字
                            const deptId = localStorage.getItem('department_id');
                            crud.currentItem.department_id = deptId ? parseInt(deptId) : null;
                        }
                    }
                }
            });

            return {
                ...crud,
                taskRules,
                departments,
                allDatabases,
                filteredDatabases,
                onDepartmentChange,
                formatDateTime,
                statusType,
                ElementPlusIcons
            };
        }
    };

    // --- SyncTask Component (JDY -> DB) ---
    const SyncTaskViewJdyToDb = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>简道云 -> 数据库 同步任务管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加任务</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%" row-key="id">
              <el-table-column prop="id" label="ID" width="50"></el-table-column>
              <el-table-column v-if="isSuperuser" prop="department_name" label="所属部门" width="150"
                               sortable></el-table-column>
              <el-table-column prop="task_name" label="任务名称" sortable></el-table-column>
              <el-table-column prop="db_show_name" label="目标数据库" sortable>
                <template #default="scope">
                  <el-tag type="success">{{ scope.row.db_show_name || 'N/A' }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="table_name" label="目标表名 (自动)" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID (自动)" width="250"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID (自动)" width="250"></el-table-column>
              <el-table-column prop="daily_sync_type" label="全量同步类型" width="120">
                <template #default="scope">{{ scope.row.daily_sync_type || 'N/A' }}</template>
              </el-table-column>
              <el-table-column prop="daily_sync_time" label="定时同步时间" width="120">
                <template #default="scope">{{ formatTime(scope.row.daily_sync_time) }}</template>
              </el-table-column>
              <el-table-column prop="last_sync_time" label="上次同步时间" width="170">
                <template #default="scope">{{ formatDateTime(scope.row.last_sync_time) }}</template>
              </el-table-column>
              <el-table-column prop="is_active" label="激活" width="70">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="200" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)"
                             :icon="ElementPlusIcons.Delete">删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑任务' : '添加任务'" width="700px"
                       @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="taskRules" label-position="top" label-width="150px">

                <input type="hidden" v-model="currentItem.sync_type"/>

                <el-form-item label="Webhook URL (保存后生成)" v-if="isEdit && currentItem.webhook_url">
                  <div class="form-item-note">将此 URL 粘贴到简道云对应表单的「数据推送」设置中。</div>
                  <el-input v-model="currentItem.webhook_url" readonly>
                    <template #append>
                      <el-button @click="copyWebhookUrl(currentItem.webhook_url)"
                                 :icon="ElementPlusIcons.DocumentCopy"></el-button>
                    </template>
                  </el-input>
                </el-form-item>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="任务名称" prop="task_name">
                      <el-input v-model="currentItem.task_name" placeholder="例如：销售订单接收"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="所属部门 (租户)" prop="department_id" v-if="isSuperuser">
                      <el-select v-model="currentItem.department_id" placeholder="选择所属部门"
                                 @change="onDepartmentChange">
                        <el-option v-for="dept in departments" :key="dept.id"
                                   :label="dept.department_name" :value="dept.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="目标数据库" prop="database_id">
                      <el-select v-model="currentItem.database_id" placeholder="选择目标数据库">
                        <el-option v-for="db in filteredDatabases" :key="db.id"
                                   :label="db.db_show_name" :value="db.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="目标数据库表名" prop="table_name">
                      <el-input v-model="currentItem.table_name"
                                placeholder="数据库中的表名 (若不存在将自动创建)"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="简道云 App ID" prop="app_id">
                      <div class="form-item-note">可不填，在首次收到 Webhook 数据时系统自动填充</div>
                      <el-input v-model="currentItem.app_id" placeholder="App ID (自动填充)"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="简道云 Entry ID" prop="entry_id">
                      <div class="form-item-note">可不填，在首次收到 Webhook 数据时系统自动填充</div>
                      <el-input v-model="currentItem.entry_id" placeholder="Entry ID (自动填充)"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-form-item label="简道云 Webhook API Secret (用于签名校验)" prop="api_secret">
                  <div class="form-item-note">在简道云「数据推送」中设置的 API Secret，若设置了则必须填写</div>
                  <el-input
                    type="password"
                    v-model="currentItem.api_secret"
                    :placeholder="isEdit ? '***************************' : '请输入 API Secret (选填)'"
                    show-password>
                  </el-input>
                </el-form-item>

                <el-divider>表结构配置</el-divider>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="列名转换拼音">
                      <el-switch v-model="currentItem.label_to_pinyin"></el-switch>
                      <div class="form-item-note">开启后，将使用表单字段的"名称"转为拼音</div>
                      <div class="form-item-note">关闭后，将优先使用表单字段的"别名" (如已设置)</div>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="JSON/数组 存为字符串">
                      <el-switch v-model="currentItem.json_as_string"></el-switch>
                      <div class="form-item-note">开启后，JSON 将自动转换为 TEXT</div>
                      <div class="form-item-note">关闭后，将尝试存为数据库的 JSON 类型 (若支持)</div>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-divider>定时全量同步</el-divider>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="全量同步类型" prop="daily_sync_type">
                      <el-select v-model="currentItem.daily_sync_type" placeholder="选择全量同步类型">
                        <el-option label="ONCE (仅首次)" value="ONCE"></el-option>
                        <el-option label="DAILY (每日定时)" value="DAILY"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="任务激活">
                      <el-switch v-model="currentItem.is_active"></el-switch>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12" v-if="currentItem.daily_sync_type === 'DAILY'">
                    <el-form-item label="每日同步时间" prop="daily_sync_time">
                      <el-time-picker v-model="currentItem.daily_sync_time_temp" format="HH:mm"
                                      value-format="HH:mm:ss"
                                      placeholder="选择时间"></el-time-picker>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="首次执行全量同步">
                      <el-switch v-model="currentItem.is_full_sync_first"></el-switch>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12" v-if="currentItem.is_full_sync_first">
                    <el-form-item label="⚠️首次全量同步时，执行清空目标表操作">
                      <el-switch v-model="currentItem.is_delete_first"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-divider>通知配置</el-divider>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="发送企微错误日志">
                      <el-switch v-model="currentItem.send_error_log_to_wecom"></el-switch>
                    </el-form-item>
                  </el-col>
                </el-row>
                <el-form-item label="企微机器人 Webhook URL" prop="wecom_robot_webhook_url"
                              v-if="currentItem.send_error_log_to_wecom">
                  <el-input type="textarea" v-model="currentItem.wecom_robot_webhook_url"
                            placeholder="如果打开了企微错误通知，请粘贴机器人 URL"></el-input>
                </el-form-item>

              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // 3.6 - Default item for jdy2db
            const defaultTask = {
                task_name: '',
                department_id: null,
                database_id: null,
                table_name: '',
                is_active: true,
                is_full_sync_first: false,
                is_delete_first: false,
                daily_sync_time_temp: null,
                daily_sync_time: null,
                daily_sync_type: 'ONCE',
                json_as_string: false,
                label_to_pinyin: false,
                send_error_log_to_wecom: false,
                wecom_robot_webhook_url: null,
                sync_type: 'jdy2db', // 3.6 - Hardcode type
                api_secret: null
            };

            // 3.6 - Fix API endpoint
            const crud = useCrud('/sync-tasks?sync_type=jdy2db', '同步任务', defaultTask, 'id');
            const departments = ref([]);
            const allDatabases = ref([]);

            const filteredDatabases = computed(() => {
                // 过滤出 sync_type = 'jdy2db' 的数据库
                let dbs = allDatabases.value.filter(db => db.sync_type === 'jdy2db');
                if (props.isSuperuser) {
                    if (!crud.currentItem.department_id) return [];
                    return dbs.filter(db => db.department_id === crud.currentItem.department_id);
                }
                return dbs;
            });

            const validateDailyTime = (rule, value, callback) => {
                if (crud.currentItem.daily_sync_type === 'DAILY' && !crud.currentItem.daily_sync_time_temp) {
                    callback(new Error('请选择每日同步时间'));
                } else {
                    callback();
                }
            };

            const taskRules = computed(() => ({
                task_name: [{required: true, message: '请输入任务名称', trigger: 'blur'}],
                department_id: [{required: props.isSuperuser, message: '请选择所属部门', trigger: 'change'}],
                database_id: [{required: true, message: '请选择目标数据库', trigger: 'change'}],
                table_name: [{required: false, message: '请输入目标表名', trigger: 'blur'}],
                daily_sync_time: [{validator: validateDailyTime, trigger: 'change'}],
                api_secret: [{required: false, message: '请输入 API Secret', trigger: 'blur'}],
            }));

            const onDepartmentChange = () => {
                if (props.isSuperuser) {
                    crud.currentItem.database_id = null;
                }
            };
            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try {
                        departments.value = (await apiClient.get('/departments')).data;
                    } catch (e) {
                        console.error(e);
                    }
                }
            };
            const fetchAllDatabases = async () => {
                try {
                    allDatabases.value = (await apiClient.get('/databases')).data;
                } catch (error) {
                    console.error("获取数据库列表失败:", error);
                }
            };

            const formatTime = (isoTime) => {
                if (!isoTime) return '-';
                try {
                    // isoTime might be "HH:MM:SS" or "YYYY-MM-DDTHH:MM:SS"
                    const timePart = isoTime.split('T').pop();
                    return timePart.substring(0, 5); // "HH:MM"
                } catch (e) {
                    return isoTime;
                }
            };

            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';

            // copyWebhookUrl
            const copyWebhookUrl = async (urlToCopy) => {
                if (!urlToCopy) {
                    ElMessage.error('没有可复制的 URL');
                    return;
                }

                try {
                    // 方案 A: 尝试使用现代 Clipboard API
                    // (仅在 HTTPS 或 localhost 下工作)
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(urlToCopy);
                        ElMessage.success('Webhook URL 复制成功');
                    } else {
                        // 方案 B: 回退到传统的 execCommand (用于不安全的 HTTP)

                        // 创建一个临时的 textarea 元素
                        const textArea = document.createElement('textarea');
                        textArea.value = urlToCopy;

                        // 将元素隐藏在视口之外
                        textArea.style.position = 'absolute';
                        textArea.style.left = '-9999px';
                        textArea.style.top = '0';

                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select(); // 选中文本

                        let success = false;
                        try {
                            // 执行复制命令
                            success = document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback copy failed:', err);
                        }

                        // 移除临时元素
                        document.body.removeChild(textArea);

                        if (success) {
                            ElMessage.success('Webhook URL 复制成功');
                        } else {
                            ElMessage.error('复制失败，您的浏览器可能不支持');
                        }
                    }
                } catch (err) {
                    // 捕获所有可能的异常
                    console.error('复制操作失败:', err);
                    ElMessage.error('复制失败，请手动复制');
                }
            };

            watch(() => crud.dialogVisible.value, (newVal) => {
                if (newVal) {
                    fetchAllDatabases();
                    if (props.isSuperuser) fetchDepartments();
                    // 回显时间
                    if (crud.isEdit.value && crud.currentItem.daily_sync_time) {
                        crud.currentItem.daily_sync_time_temp = crud.currentItem.daily_sync_time;
                    } else if (newVal && !crud.isEdit.value) {
                        crud.currentItem.daily_sync_time_temp = null;
                        if (!props.isSuperuser) {
                            const deptId = localStorage.getItem('department_id');
                            crud.currentItem.department_id = deptId ? parseInt(deptId) : null;
                        }
                    }

                    // 处理 api_secret 的回显
                    if (crud.isEdit.value) {
                        // 当编辑时，我们将 api_secret 设置为空字符串
                        // 用户只有在需要 *修改* 时才填写
                        crud.currentItem.api_secret = '';
                    }
                }
            });

            return {
                ...crud,
                taskRules,
                departments,
                allDatabases,
                filteredDatabases,
                onDepartmentChange,
                formatTime,
                formatDateTime,
                copyWebhookUrl,
                ElementPlusIcons
            };
        }
    };


    // --- SyncLog Component (DB -> JDY) (REFACTORED) ---
    const SyncLogViewDbToJdy = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>数据库 -> 简道云 错误日志管理</span>
                <el-button @click="fetchItems" :icon="ElementPlusIcons.Refresh" :loading="loading">刷新</el-button>
              </div>
            </template>
            <el-form :inline="true" :model="filters" class="log-filter-form">
              <el-form-item label="时间范围">
                <el-date-picker v-model="filters.dateRange" type="datetimerange" range-separator="至"
                                start-placeholder="开始日期" end-placeholder="结束日期"
                                value-format="YYYY-MM-DDTHH:mm:ss"
                                :default-time="[new Date(2000, 1, 1, 0, 0, 0), new Date(2000, 2, 1, 23, 59, 59)]"/>
              </el-form-item>
              <el-form-item label="部门" v-if="isSuperuser">
                <el-input v-model.number="filters.departmentIdFilter" placeholder="部门ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item label="任务ID">
                <el-input v-model.number="filters.taskIdFilter" placeholder="任务ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item style="margin-left: auto;">
                <el-button @click="clearFilters" :icon="ElementPlusIcons.CircleClose">清空筛选</el-button>
              </el-form-item>
            </el-form>
            <el-table :data="filteredLogs" v-loading="loading" style="width: 100%" height="calc(100vh - 270px)">
              <el-table-column type="expand">
                <template #default="props">
                  <div style="padding: 10px; background-color: #f9f9f9;"><p><strong>Traceback:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ props.row.traceback || 'N/A' }}</pre>
                    <p><strong>Payload:</strong></p>
                    <pre
                        style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;">{{ formatPayload(props.row.payload) }}</pre>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="id" label="ID" min-width="70"></el-table-column>
              <el-table-column prop="timestamp" label="时间" min-width="170" sortable>
                <template #default="scope">{{ formatDateTime(scope.row.timestamp) }}</template>
              </el-table-column>
              <el-table-column prop="department_name" label="所属部门" min-width="120" v-if="isSuperuser"
                               sortable></el-table-column>
              <el-table-column prop="task_id" label="任务ID" min-width="80" sortable></el-table-column>
              <el-table-column prop="table_name" label="表名" min-width="150" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID" min-width="200"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID" min-width="200"></el-table-column>
              <el-table-column prop="error_message" label="错误信息" min-width="250">
                <template #default="scope">
                  <div style="white-space: pre-wrap;">{{ scope.row.error_message }}</div>
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // 3.6 - Fix API endpoint
            const {items, loading, fetchItems} = useCrud('/sync-logs?sync_type=db2jdy', '日志');
            const filters = reactive({dateRange: null, departmentIdFilter: '', taskIdFilter: ''});

            const filteredLogs = computed(() => {
                let logs = items.value;
                if (filters.dateRange?.length === 2) {
                    const [start, end] = [new Date(filters.dateRange[0]).getTime(), new Date(filters.dateRange[1]).getTime()];
                    logs = logs.filter(log => {
                        const t = new Date(log.timestamp).getTime();
                        return t >= start && t <= end;
                    });
                }
                if (props.isSuperuser && filters.departmentIdFilter) {
                    logs = logs.filter(log => log.department_id === filters.departmentIdFilter);
                }
                if (filters.taskIdFilter) {
                    logs = logs.filter(log => log.task_id === filters.taskIdFilter);
                }
                return logs;
            });
            const clearFilters = () => {
                filters.dateRange = null;
                filters.departmentIdFilter = '';
                filters.taskIdFilter = '';
            };
            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const formatPayload = (payloadStr) => {
                if (!payloadStr) return 'N/A';
                try {
                    return JSON.stringify(JSON.parse(payloadStr), null, 2);
                } catch (e) {
                    return payloadStr;
                }
            };
            return {
                items,
                loading,
                fetchItems,
                filters,
                filteredLogs,
                clearFilters,
                formatDateTime,
                formatPayload,
                ElementPlusIcons
            };
        }
    };

    // --- SyncLog Component (JDY -> DB) (NEW) ---
    const SyncLogViewJdyToDb = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>简道云 -> 数据库 错误日志管理</span>
                <el-button @click="fetchItems" :icon="ElementPlusIcons.Refresh" :loading="loading">刷新</el-button>
              </div>
            </template>
            <el-form :inline="true" :model="filters" class="log-filter-form">
              <el-form-item label="时间范围">
                <el-date-picker v-model="filters.dateRange" type="datetimerange" range-separator="至"
                                start-placeholder="开始日期" end-placeholder="结束日期"
                                value-format="YYYY-MM-DDTHH:mm:ss"
                                :default-time="[new Date(2000, 1, 1, 0, 0, 0), new Date(2000, 2, 1, 23, 59, 59)]"/>
              </el-form-item>
              <el-form-item label="部门" v-if="isSuperuser">
                <el-input v-model.number="filters.departmentIdFilter" placeholder="部门ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item label="任务ID">
                <el-input v-model.number="filters.taskIdFilter" placeholder="任务ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item style="margin-left: auto;">
                <el-button @click="clearFilters" :icon="ElementPlusIcons.CircleClose">清空筛选</el-button>
              </el-form-item>
            </el-form>
            <el-table :data="filteredLogs" v-loading="loading" style="width: 100%" height="calc(100vh - 270px)">
              <el-table-column type="expand">
                <template #default="props">
                  <div style="padding: 10px; background-color: #f9f9f9;"><p><strong>Traceback:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ props.row.traceback || 'N/A' }}</pre>
                    <p><strong>Payload:</strong></p>
                    <pre
                        style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;">{{ formatPayload(props.row.payload) }}</pre>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="id" label="ID" min-width="70"></el-table-column>
              <el-table-column prop="timestamp" label="时间" min-width="170" sortable>
                <template #default="scope">{{ formatDateTime(scope.row.timestamp) }}</template>
              </el-table-column>
              <el-table-column prop="department_name" label="所属部门" min-width="120" v-if="isSuperuser"
                               sortable></el-table-column>
              <el-table-column prop="task_id" label="任务ID" min-width="80" sortable></el-table-column>
              <el-table-column prop="table_name" label="表名" min-width="150" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID" min-width="120"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID" min-width="120"></el-table-column>
              <el-table-column prop="error_message" label="错误信息" min-width="250">
                <template #default="scope">
                  <div style="white-space: pre-wrap;">{{ scope.row.error_message }}</div>
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // 3.6 - Fix API endpoint
            const {items, loading, fetchItems} = useCrud('/sync-logs?sync_type=jdy2db', '日志');
            const filters = reactive({dateRange: null, departmentIdFilter: '', taskIdFilter: ''});
            const filteredLogs = computed(() => {
                let logs = items.value;
                if (filters.dateRange?.length === 2) {
                    const [start, end] = [new Date(filters.dateRange[0]).getTime(), new Date(filters.dateRange[1]).getTime()];
                    logs = logs.filter(log => {
                        const t = new Date(log.timestamp).getTime();
                        return t >= start && t <= end;
                    });
                }
                // 适配多租户
                if (props.isSuperuser && filters.departmentIdFilter) {
                    logs = logs.filter(log => log.department_id === filters.departmentIdFilter);
                }
                if (filters.taskIdFilter) {
                    logs = logs.filter(log => log.task_id === filters.taskIdFilter);
                }
                return logs;
            });
            const clearFilters = () => {
                filters.dateRange = null;
                filters.departmentIdFilter = '';
                filters.taskIdFilter = '';
            };
            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const formatPayload = (payloadStr) => {
                if (!payloadStr) return 'N/A';
                try {
                    return JSON.stringify(JSON.parse(payloadStr), null, 2);
                } catch (e) {
                    return payloadStr;
                }
            };
            return {
                items,
                loading,
                fetchItems,
                filters,
                filteredLogs,
                clearFilters,
                formatDateTime,
                formatPayload,
                ElementPlusIcons
            };
        }
    };

    // --- Router Setup (适配多租户) ---
    const routes = [
        // 3.6 - Default route
        {path: '/', redirect: '/tasks-db-to-jdy'},

        {path: '/departments', component: DepartmentView},
        {path: '/users', component: UserView},
        {path: '/databases', component: DatabaseView},
        {path: '/jdy-keys', component: JdyKeyInfoView},

        // 3.6 - Split routes
        {path: '/tasks-db-to-jdy', component: SyncTaskViewDbToJdy},
        {path: '/tasks-jdy-to-db', component: SyncTaskViewJdyToDb},
        {path: '/logs-db-to-jdy', component: SyncLogViewDbToJdy},
        {path: '/logs-jdy-to-db', component: SyncLogViewJdyToDb}
    ];
    const router = VueRouter.createRouter({history: VueRouter.createWebHashHistory(), routes});

    // --- App Setup (适配 JWT) ---
    const app = createApp({
        setup() {
            const isAuthenticated = ref(false);
            const username = ref('');
            const isSuperuser = ref(false);
            const departmentName = ref('');

            const route = useRoute();
            const routerInstance = useRouter();

            // 检查 localStorage
            const checkAuthentication = () => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    isAuthenticated.value = true;
                    username.value = localStorage.getItem('username') || '';
                    isSuperuser.value = localStorage.getItem('is_superuser') === 'true';
                    departmentName.value = localStorage.getItem('department_name') || 'N/A';
                } else {
                    isAuthenticated.value = false;
                }
            };

            // 登录成功处理器
            const handleLoginSuccess = (userData) => {
                isAuthenticated.value = true;
                username.value = userData.username;
                isSuperuser.value = userData.is_superuser;
                departmentName.value = userData.department_name || 'N/A';
                routerInstance.push('/');
            };

            // 登出处理器
            const handleLogout = async (force = false) => {
                if (!force) {
                    try {
                        // 调用 /api/logout (DELETE) 来吊销Token
                        // auth.py 中没有 /logout 路由，所以跳过它
                        // await apiClient.delete('/logout');
                    } catch (error) {
                        console.error("Logout failed, proceeding with client-side cleanup:", error);
                    }
                }

                // 清理 localStorage
                localStorage.clear();
                isAuthenticated.value = false;
                username.value = '';
                isSuperuser.value = false;
                departmentName.value = '';

                if (!force) {
                    ElMessage.info('已退出登录。');
                }
            };

            const activeMenu = computed(() => route.path);

            onMounted(checkAuthentication); // 启动时检查

            // 将登出函数暴露给拦截器
            window.appInstance = {handleLogout};

            return {
                isAuthenticated,
                username,
                isSuperuser,
                departmentName,
                activeMenu,
                handleLoginSuccess,
                logout: handleLogout, // 暴露给模板
                zhCn: ElementPlusLocaleZhCn.default
            };
        }
    });

    // Register components globally
    app.component('login-view', LoginView);
    // 注册新组件
    app.component('DepartmentView', DepartmentView);
    app.component('UserView', UserView);
    app.component('DatabaseView', DatabaseView);
    app.component('JdyKeyInfoView', JdyKeyInfoView);

    // 3.6 - Register new components
    app.component('SyncTaskViewDbToJdy', SyncTaskViewDbToJdy);
    app.component('SyncTaskViewJdyToDb', SyncTaskViewJdyToDb);
    app.component('SyncLogViewDbToJdy', SyncLogViewDbToJdy);
    app.component('SyncLogViewJdyToDb', SyncLogViewJdyToDb);

    // --- START FIX ---
    // 修复了将 ElementPlusIconsVue 错误地用于循环的 BUG
    for (const [key, component] of Object.entries(ElementPlusIcons)) {
        app.component(key, component)
    }
    // --- END FIX ---

    app.use(router);
    // 从本地加载中文语言包
    app.use(ElementPlus, {locale: ElementPlusLocaleZhCn.default});
    app.mount('#app');
</script>
</body>
</html>