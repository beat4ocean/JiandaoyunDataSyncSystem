<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL数据同步至简道云配置</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css"/>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; background-color: #f4f4f5; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .login-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background-color: #f4f4f5; }
        .login-card { width: 400px; padding: 40px 30px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0, 0, 0, .1); background-color: #fff; text-align: center; }
        .login-title { font-size: 24px; font-weight: bold; color: #303133; margin-bottom: 25px; }
        .login-card h2 { font-size: 18px; color: #606266; margin-top: 0; margin-bottom: 20px; }
        .app-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: #fff; }
        .full-height-container { flex-grow: 1; display: flex; overflow: hidden; }
        .el-main { padding: 0; flex-grow: 1; overflow-y: auto; background-color: #f4f4f5; }
        .el-header { background-color: #fff; color: #303133; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; border-bottom: 1px solid #e4e7ed; }
        .el-header h2 { font-size: 20px; }
        .el-menu { border-right: none; }
        .el-menu-item.is-active { background-color: #ecf5ff; }
        .config-card { margin: 20px; }
        .form-dialog .el-input, .form-dialog .el-select, .form-dialog .el-time-picker { width: 100%; }
        .form-dialog .el-form-item { margin-bottom: 15px; }
        .el-table .cell { white-space: pre-wrap; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .el-aside { flex-shrink: 0; background-color: #fff; border-right: 1px solid #eee; padding-top: 10px; }
        .log-filter-form { padding: 15px 0 0 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .log-filter-form .el-form-item { margin-bottom: 0; }
        .visibility-toggle-btn { margin-left: 8px; }
        .form-item-note { font-size: 12px; color: #909399; margin-top: -5px; line-height: 1.2; }
    </style>
</head>
<body>
<div id="app">
    <el-config-provider :locale="zhCn">
        <template v-if="!isAuthenticated">
            <div class="login-container">
                <login-view @login-success="handleLoginSuccess"></login-view>
            </div>
        </template>
        <template v-else>
            <div class="app-container">
                <el-header height="60px">
                    <h2>MySQL同步至简道云配置</h2>
                    <div>
                        <span>你好, {{ username }} ({{ isSuperuser ? '超级管理员' : '租户: ' + departmentName }})</span>
                        <el-button type="danger" link @click="logout" style="margin-left: 15px;">退出登录</el-button>
                    </div>
                </el-header>
                <el-container class="full-height-container">
                    <el-aside width="200px">
                        <el-menu :default-active="activeMenu" router>
                            <el-menu-item index="/departments" v-if="isSuperuser">
                                <el-icon><OfficeBuilding/></el-icon>
                                <span>部门管理</span>
                            </el-menu-item>
                            <el-menu-item index="/users" v-if="isSuperuser">
                                <el-icon><User/></el-icon>
                                <span>用户管理</span>
                            </el-menu-item>

                            <el-menu-item index="/databases">
                                <el-icon><Coin/></el-icon>
                                <span>源库管理</span>
                            </el-menu-item>

                            <el-menu-item index="/jdy-keys">
                                <el-icon><Key/></el-icon>
                                <span>简道云密钥</span>
                            </el-menu-item>

                            <el-menu-item index="/sync-tasks">
                                <el-icon><Tickets/></el-icon>
                                <span>任务管理</span>
                            </el-menu-item>

                            <el-menu-item index="/error-logs">
                                <el-icon><Document/></el-icon>
                                <span>错误日志</span>
                            </el-menu-item>
                        </el-menu>
                    </el-aside>
                    <el-main>
                        <router-view
                            :is-superuser="isSuperuser"
                            :key="activeMenu"
                        ></router-view>
                    </el-main>
                </el-container>
            </div>
        </template>
    </el-config-provider>
</div>

<script>
    const ElementPlusIcons = window.ElementPlusIconsVue || {};
    const {createApp, ref, reactive, computed, onMounted, watch} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;
    const {useRoute, useRouter} = VueRouter;

    // --- (新) 全局状态 ---
    // 用于在刷新时处理并发请求
    let isRefreshingToken = false;
    let failedRequestQueue = [];

    // --- (新) Axios 实例 (适配 JWT Bearer Token) ---
    const apiClient = axios.create({
        baseURL: '/api' // (新) 统一使用 /api 前缀
    });

    // (新) 请求拦截器：自动附加 Bearer Token
    apiClient.interceptors.request.use(config => {
        const token = localStorage.getItem('access_token');
        if (token) {
            config.headers['Authorization'] = `Bearer ${token}`;
        }
        return config;
    });

    // (新) 响应拦截器：处理 401 自动刷新
    apiClient.interceptors.response.use(
        response => response,
        async error => {
            const originalRequest = error.config;

            // 1. 如果是 401 错误，并且不是 /refresh 或 /login 失败
            if (error.response?.status === 401 && !originalRequest._retry) {
                if (originalRequest.url.endsWith('/login') || originalRequest.url.endsWith('/refresh')) {
                    // 登录或刷新失败，直接登出
                    window.appInstance?.handleLogout(true); // 强制登出
                    return Promise.reject(error.response?.data?.msg || '认证失败');
                }

                originalRequest._retry = true; // 标记为重试

                // 2. 处理并发的刷新请求
                if (isRefreshingToken) {
                    // 如果正在刷新，将失败的请求存入队列
                    return new Promise((resolve, reject) => {
                        failedRequestQueue.push({ resolve, reject, config: originalRequest });
                    });
                }

                isRefreshingToken = true;
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    window.appInstance?.handleLogout(true);
                    return Promise.reject('无刷新令牌，请重新登录。');
                }

                try {
                    // 3. 尝试获取新 Token
                    const refreshResponse = await axios.post('/api/refresh', {}, {
                        headers: { 'Authorization': `Bearer ${refreshToken}` }
                    });

                    const newAccessToken = refreshResponse.data.access_token;
                    localStorage.setItem('access_token', newAccessToken);

                    // 4. 更新当前请求的 Header 并重新发送
                    originalRequest.headers['Authorization'] = `Bearer ${newAccessToken}`;

                    // (重要) 处理队列中所有等待的请求
                    failedRequestQueue.forEach(req => {
                        req.config.headers['Authorization'] = `Bearer ${newAccessToken}`;
                        apiClient(req.config).then(req.resolve).catch(req.reject);
                    });
                    failedRequestQueue = [];

                    isRefreshingToken = false;
                    return apiClient(originalRequest); // 返回重试的原始请求

                } catch (refreshError) {
                    // 5. 刷新失败，登出
                    console.error("Token refresh failed:", refreshError);
                    window.appInstance?.handleLogout(true);
                    ElMessage.error('会话已过期，请重新登录。');
                    isRefreshingToken = false;
                    failedRequestQueue = [];
                    return Promise.reject(refreshError);
                }
            }

            // (原) 处理其他错误
            if (error.response?.data?.error) {
                ElMessage.error(`操作失败: ${error.response.data.error}`);
            } else if (error.response?.data?.msg) {
                 ElMessage.error(`操作失败: ${error.response.data.msg}`);
            } else if (error.message) {
                ElMessage.error(`请求错误: ${error.message}`);
            } else {
                ElMessage.error('发生未知错误');
            }
            return Promise.reject(error);
        }
    );

    // --- (新) Reusable CRUD Composable (适配新 API) ---
    function useCrud(apiEndpoint, itemName = '项目', defaultItem = {}, idKey = 'id') {
        const items = ref([]);
        const loading = ref(false);
        const dialogVisible = ref(false);
        const isEdit = ref(false);
        const currentItem = reactive({});
        const formRef = ref(null);

        const fetchItems = async () => {
            loading.value = true;
            try {
                const response = await apiClient.get(apiEndpoint);
                items.value = response.data;
            } catch (error) {
                console.error(`获取 ${itemName} 列表失败:`, error);
            } finally {
                loading.value = false;
            }
        };

        const openDialog = (item = null) => {
            if (item) {
                isEdit.value = true;
                Object.assign(currentItem, JSON.parse(JSON.stringify(item)));
            } else {
                isEdit.value = false;
                Object.keys(currentItem).forEach(key => delete currentItem[key]);
                Object.assign(currentItem, JSON.parse(JSON.stringify(defaultItem)));
            }
            dialogVisible.value = true;
            Vue.nextTick(() => {
                if (formRef.value) formRef.value.clearValidate();
            });
        };

        const closeDialog = () => {
            dialogVisible.value = false;
        };

        const saveItem = async () => {
            if (!formRef.value) return;
            try {
                await formRef.value.validate();
            } catch (error) {
                ElMessage.warning('请检查表单输入。');
                return;
            }

            loading.value = true;
            // (新) 使用 idKey
            const url = isEdit.value ? `${apiEndpoint}/${currentItem[idKey]}` : apiEndpoint;
            const method = isEdit.value ? 'put' : 'post';

            try {
                const dataToSend = {...currentItem};

                // (新) 清理前端临时字段
                if ('full_replace_time_temp' in dataToSend) {
                    dataToSend.full_replace_time = dataToSend.full_replace_time_temp || null;
                    delete dataToSend.full_replace_time_temp;
                }
                // (新) 清理密码
                if (method === 'put' && 'password' in dataToSend && !dataToSend.password) {
                    delete dataToSend.password;
                }

                const response = await apiClient[method](url, dataToSend);

                if (isEdit.value) {
                    const index = items.value.findIndex(i => i[idKey] === currentItem[idKey]);
                    if (index !== -1) items.value.splice(index, 1, response.data);
                } else {
                    items.value.push(response.data);
                }
                closeDialog();
                ElMessage.success(`${itemName} 保存成功！`);
            } catch (error) {
                console.error(`保存 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };

        const deleteItem = async (id) => {
            try {
                await ElMessageBox.confirm(`确定要删除这个 ${itemName} (ID: ${id}) 吗?`, '警告', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                });
                loading.value = true;
                await apiClient.delete(`${apiEndpoint}/${id}`);
                items.value = items.value.filter(i => i[idKey] !== id);
                ElMessage.success(`${itemName} 删除成功！`);
            } catch (error) {
                if (error !== 'cancel') console.error(`删除 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };
        onMounted(fetchItems);
        return { items, loading, dialogVisible, isEdit, currentItem, formRef, fetchItems, openDialog, closeDialog, saveItem, deleteItem };
    }

    // --- (新) Login Component (适配 /api/login 和 JWT) ---
    const LoginView = {
        template: `
          <el-card class="login-card">
            <h1 class="login-title">MySQL -> 简道云 数据同步系统</h1>
            <h2>登录</h2>
            <el-form @submit.prevent="submitLogin" ref="loginFormRef" :model="loginForm" :rules="loginRules" label-position="top">
              <el-form-item label="用户名" prop="username">
                <el-input v-model="loginForm.username" placeholder="请输入用户名"></el-input>
              </el-form-item>
              <el-form-item label="密码" prop="password">
                <el-input type="password" v-model="loginForm.password" placeholder="请输入密码" show-password></el-input>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" native-type="submit" :loading="loading" style="width: 100%;">登录</el-button>
              </el-form-item>
            </el-form>
          </el-card>
        `,
        emits: ['login-success'],
        setup(props, {emit}) {
            const loginForm = reactive({username: '', password: ''});
            const loading = ref(false);
            const loginFormRef = ref(null);
            const loginRules = {
                username: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: true, message: '请输入密码', trigger: 'blur'}],
            };
            const submitLogin = async () => {
                if (!loginFormRef.value) return;
                try { await loginFormRef.value.validate(); } catch (error) { return; }
                loading.value = true;
                try {
                    // (新) 使用 axios.post 访问 /api/login
                    const response = await axios.post('/api/login', loginForm);
                    const data = response.data;

                    // (新) 存储所有 Token 和用户信息
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('is_superuser', data.is_superuser);
                    localStorage.setItem('department_name', data.department_name || 'N/A');

                    emit('login-success', data); // (新) 传递所有用户数据
                    ElMessage.success('登录成功!');
                } catch (error) {
                    console.error("登录失败:", error);
                    // (新) 显示后端错误
                    const msg = error.response?.data?.msg || '登录失败，请检查用户名或密码';
                    ElMessage.error(msg);
                } finally {
                    loading.value = false;
                }
            };
            return {loginForm, loading, loginFormRef, loginRules, submitLogin};
        }
    };

    // --- (新) Department Component ---
    const DepartmentView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>部门管理 (租户)</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加部门</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="部门ID (外部)" width="120" sortable></el-table-column>
              <el-table-column prop="department_name" label="部门简称 (英文)" sortable></el-table-column>
              <el-table-column prop="is_active" label="是否激活" width="100">
                <template #default="scope"> <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}</el-tag> </template>
              </el-table-column>
              <el-table-column label="操作" width="180" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑部门' : '添加部门'" width="500px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <el-form-item label="部门ID (外部)" prop="id">
                  <el-input v-model.number="currentItem.id" placeholder="唯一的数字ID" :disabled="isEdit"></el-input>
                </el-form-item>
                <el-form-item label="部门简称 (英文)" prop="department_name">
                  <el-input v-model="currentItem.department_name" placeholder="例如：sales_dept (唯一)"></el-input>
                </el-form-item>
                 <el-form-item label="是否激活">
                   <el-switch v-model="currentItem.is_active"></el-switch>
                 </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        setup() {
            const defaultItem = { id: null, department_name: '', is_active: true };
            const crud = useCrud('/departments', '部门', defaultItem, 'id');
            const formRules = {
                id: [{required: true, message: '请输入部门ID', trigger: 'blur'}],
                department_name: [{required: true, message: '请输入部门简称', trigger: 'blur'}],
            };
            return {...crud, formRules, ElementPlusIcons};
        }
    };

    // --- (新) User Component ---
    const UserView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>用户管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加用户</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="80" sortable></el-table-column>
              <el-table-column prop="username" label="用户名" sortable></el-table-column>
              <el-table-column prop="department_id" label="所属部门ID" sortable></el-table-column>
              <el-table-column prop="is_superuser" label="超级管理员" width="120">
                <template #default="scope"> <el-tag :type="scope.row.is_superuser ? 'danger' : 'info'">{{ scope.row.is_superuser ? '是' : '否' }}</el-tag> </template>
              </el-table-column>
              <el-table-column prop="is_active" label="是否激活" width="100">
                <template #default="scope"> <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}</el-tag> </template>
              </el-table-column>
              <el-table-column label="操作" width="250" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openResetPassword(scope.row)" :icon="ElementPlusIcons.RefreshLeft">重置密码</el-button>
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑用户' : '添加用户'" width="500px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <el-form-item label="用户名" prop="username">
                  <el-input v-model="currentItem.username" placeholder="登录用户名"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password" v-if="!isEdit">
                  <el-input type="password" v-model="currentItem.password" placeholder="新增时必填" show-password></el-input>
                </el-form-item>
                <el-form-item label="所属部门" prop="department_id">
                   <el-select v-model="currentItem.department_id" placeholder="选择所属部门">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name + ' (ID: ' + dept.id + ')'" :value="dept.id"></el-option>
                   </el-select>
                </el-form-item>
                <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="超级管理员">
                       <el-switch v-model="currentItem.is_superuser"></el-switch>
                     </el-form-item>
                   </el-col>
                   <el-col :span="12">
                     <el-form-item label="是否激活">
                       <el-switch v-model="currentItem.is_active"></el-switch>
                     </el-form-item>
                   </el-col>
                </el-row>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>

            <el-dialog v-model="resetPasswordDialogVisible" title="重置密码" width="400px" class="form-dialog">
               <el-form ref="resetFormRef" :model="resetPasswordData" :rules="resetPasswordRules" label-position="top">
                 <p>正在为用户 <strong>{{ currentItem.username }}</strong> 重置密码。</p>
                 <el-form-item label="新密码" prop="new_password">
                   <el-input type="password" v-model="resetPasswordData.new_password" placeholder="请输入新密码" show-password></el-input>
                 </el-form-item>
               </el-form>
               <template #footer>
                <el-button @click="resetPasswordDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitResetPassword" :loading="loading">确认重置</el-button>
              </template>
             </el-dialog>
          </el-card>
        `,
        setup() {
            const defaultItem = { username: '', password: '', department_id: null, is_superuser: false, is_active: true };
            const crud = useCrud('/users', '用户', defaultItem, 'id');
            const departments = ref([]);

            // (新) 重置密码状态
            const resetPasswordDialogVisible = ref(false);
            const resetPasswordData = reactive({ new_password: '' });
            const resetFormRef = ref(null);

            const formRules = {
                username: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: crud.isEdit.value ? false : true, message: '请输入密码', trigger: 'blur'}],
                department_id: [{required: true, message: '请选择部门', trigger: 'change'}],
            };
            const resetPasswordRules = {
                new_password: [{required: true, message: '请输入新密码', trigger: 'blur'}],
            };

            const fetchDepartments = async () => {
                try { departments.value = (await apiClient.get('/departments')).data; } catch (e) { console.error(e); }
            };

            const openResetPassword = (user) => {
                Object.assign(crud.currentItem, user); // 锁定当前用户
                resetPasswordData.new_password = '';
                resetPasswordDialogVisible.value = true;
                Vue.nextTick(() => resetFormRef.value?.clearValidate());
            };

            const submitResetPassword = async () => {
                if (!resetFormRef.value) return;
                try { await resetFormRef.value.validate(); } catch (e) { return; }

                crud.loading.value = true;
                try {
                    await apiClient.patch(`/users/${crud.currentItem.id}/reset-password`, resetPasswordData);
                    ElMessage.success(`用户 ${crud.currentItem.username} 的密码重置成功！`);
                    resetPasswordDialogVisible.value = false;
                } catch (error) {
                    console.error("重置密码失败:", error);
                } finally {
                    crud.loading.value = false;
                }
            };

            onMounted(fetchDepartments);

            return {
                ...crud, formRules, departments,
                resetPasswordDialogVisible, resetPasswordData, resetFormRef, resetPasswordRules,
                openResetPassword, submitResetPassword,
                ElementPlusIcons
            };
        }
    };

    // --- (新) Database Component ---
    const DatabaseView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>源数据库管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加数据库</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="60" sortable></el-table-column>
              <el-table-column v-if="isSuperuser" prop="department_id" label="部门ID" width="100" sortable></el-table-column>
              <el-table-column prop="db_show_name" label="显示名称" sortable></el-table-column>
              <el-table-column prop="db_type" label="类型" width="100"></el-table-column>
              <el-table-column prop="db_host" label="主机"></el-table-column>
              <el-table-column prop="db_port" label="端口" width="80"></el-table-column>
              <el-table-column prop="db_name" label="库名"></el-table-column>
              <el-table-column prop="db_user" label="用户"></el-table-column>
              <el-table-column prop="is_active" label="激活" width="80">
                <template #default="scope"> <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}</el-tag> </template>
              </el-table-column>
              <el-table-column label="操作" width="180" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑数据库' : '添加数据库'" width="600px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="formRules" label-position="top">
                <el-form-item label="所属部门" prop="department_id" v-if="isSuperuser">
                   <el-select v-model="currentItem.department_id" placeholder="选择所属部门">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name + ' (ID: ' + dept.id + ')'" :value="dept.id"></el-option>
                   </el-select>
                </el-form-item>
                 <el-form-item label="显示名称" prop="db_show_name">
                  <el-input v-model="currentItem.db_show_name" placeholder="例如：生产库"></el-input>
                </el-form-item>
                <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="数据库类型" prop="db_type">
                      <el-input v-model="currentItem.db_type" placeholder="mysql"></el-input>
                    </el-form-item>
                   </el-col>
                   <el-col :span="12">
                     <el-form-item label="主机" prop="db_host">
                      <el-input v-model="currentItem.db_host" placeholder="localhost 或 IP"></el-input>
                    </el-form-item>
                   </el-col>
                </el-row>
                 <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="端口" prop="db_port">
                      <el-input-number v-model.number="currentItem.db_port" :min="1" :max="65535" style="width: 100%;"></el-input-number>
                    </el-form-item>
                   </el-col>
                   <el-col :span="12">
                     <el-form-item label="数据库名称" prop="db_name">
                      <el-input v-model="currentItem.db_name"></el-input>
                    </el-form-item>
                   </el-col>
                </el-row>
                 <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="用户名" prop="db_user">
                      <el-input v-model="currentItem.db_user"></el-input>
                    </el-form-item>
                   </el-col>
                   <el-col :span="12">
                     <el-form-item label="密码" prop="db_password">
                      <el-input type="password" v-model="currentItem.db_password" :placeholder="isEdit ? '如需修改请输入新密码' : '请输入密码'" show-password></el-input>
                     </el-form-item>
                   </el-col>
                </el-row>
                 <el-form-item label="是否激活">
                   <el-switch v-model="currentItem.is_active"></el-switch>
                 </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            const defaultItem = { db_show_name: '', db_type: 'mysql', db_host: 'localhost', db_port: 3306, db_name: '', db_user: '', db_password: '', is_active: true, department_id: null };
            const crud = useCrud('/databases', '数据库', defaultItem, 'id');
            const departments = ref([]);

            const formRules = {
                department_id: [{required: props.isSuperuser, message: '请选择部门', trigger: 'change'}],
                db_show_name: [{required: true, message: '请输入显示名称', trigger: 'blur'}],
                db_type: [{required: true, message: '请输入类型', trigger: 'blur'}],
                db_host: [{required: true, message: '请输入主机', trigger: 'blur'}],
                db_port: [{required: true, message: '请输入端口', trigger: 'blur'}],
                db_name: [{required: true, message: '请输入库名', trigger: 'blur'}],
                db_user: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                db_password: [{required: !crud.isEdit.value, message: '请输入密码', trigger: 'blur'}],
            };

            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try { departments.value = (await apiClient.get('/departments')).data; } catch (e) { console.error(e); }
                }
            };

            onMounted(fetchDepartments);

            return {...crud, formRules, departments, ElementPlusIcons};
        }
    };

    // --- (修改) JdyKeyInfo Component (适配多租户) ---
    const JdyKeyInfoView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>简道云密钥管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加密钥</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="80"></el-table-column>
              <el-table-column prop="department_id" label="所属部门ID" v-if="isSuperuser" sortable></el-table-column>
              <el-table-column label="API Key (部分)">
                <template #default="scope"> {{ scope.row.api_key.substring(0, 10) }}... </template>
              </el-table-column>
              <el-table-column label="操作" width="180" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑密钥' : '添加密钥'" width="500px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="keyRules" label-position="top">
                <el-form-item label="所属部门" prop="department_id" v-if="isSuperuser">
                   <el-select v-model="currentItem.department_id" placeholder="选择所属部门 (1:1 关系)">
                    <el-option v-for="dept in departments" :key="dept.id" :label="dept.department_name + ' (ID: ' + dept.id + ')'" :value="dept.id"></el-option>
                   </el-select>
                </el-form-item>
                <el-form-item label="API Key" prop="api_key">
                  <el-input v-model="currentItem.api_key" placeholder="请输入简道云 API Key"></el-input>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            const defaultItem = { department_id: null, api_key: '' };
            const crud = useCrud('/jdy-keys', '密钥', defaultItem, 'id');
            const departments = ref([]);

            const keyRules = {
                department_id: [{required: props.isSuperuser, message: '请选择部门', trigger: 'change'}],
                api_key: [{required: true, message: '请输入 API Key', trigger: 'blur'}],
            };

            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try { departments.value = (await apiClient.get('/departments')).data; } catch (e) { console.error(e); }
                }
            };
            onMounted(fetchDepartments);

            return {...crud, keyRules, departments, ElementPlusIcons};
        }
    };

    // --- (修改) SyncTask Component (适配多租户) ---
    const SyncTaskView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>同步任务管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加任务</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%" row-key="task_id">
              <el-table-column prop="task_id" label="ID" width="60"></el-table-column>
              <el-table-column v-if="isSuperuser" prop="department_id" label="部门ID" width="100" sortable></el-table-column>
              <el-table-column prop="task_name" label="任务名称" sortable></el-table-column>
              <el-table-column prop="source_db_name" label="源数据库" sortable>
                <template #default="scope"> <el-tag>{{ scope.row.source_db_name || 'N/A' }} (ID: {{ scope.row.source_db_id }})</el-tag> </template>
              </el-table-column>
              <el-table-column prop="source_table" label="源表名" sortable></el-table-column>
              <el-table-column prop="jdy_app_id" label="App ID"></el-table-column>
              <el-table-column prop="jdy_entry_id" label="Entry ID"></el-table-column>
              <el-table-column prop="sync_mode" label="同步模式" width="130"></el-table-column>
              <el-table-column prop="is_active" label="激活" width="70">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="status" label="运行状态" width="100">
                 <template #default="scope">
                  <el-tag :type="statusType(scope.row.status)"> {{ scope.row.status }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="last_sync_time" label="上次同步时间" width="170">
                <template #default="scope">{{ formatDateTime(scope.row.last_sync_time) }}</template>
              </el-table-column>
              <el-table-column label="操作" width="180" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.task_id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑任务' : '添加任务'" width="700px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="taskRules" label-position="top" label-width="150px">

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="任务名称" prop="task_name">
                      <el-input v-model="currentItem.task_name" placeholder="例如：销售订单同步"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                     <el-form-item label="所属部门 (租户)" prop="department_id" v-if="isSuperuser">
                      <el-select v-model="currentItem.department_id" placeholder="选择所属部门" @change="onDepartmentChange">
                        <el-option v-for="dept in departments" :key="dept.id"
                                   :label="dept.department_name + ' (ID: ' + dept.id + ')'" :value="dept.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                     <el-form-item label="源数据库" prop="source_db_id">
                      <el-select v-model="currentItem.source_db_id" placeholder="选择源数据库">
                        <el-option v-for="db in filteredDatabases" :key="db.id"
                                   :label="db.name" :value="db.id"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="源数据库表名" prop="source_table">
                      <el-input v-model="currentItem.source_table" placeholder="数据库中的表名或视图名"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="源表主键" prop="pk_field_names">
                      <el-input v-model="currentItem.pk_field_names" placeholder="e.g., id (复合主键用英文逗号分隔)"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="简道云 App ID" prop="jdy_app_id">
                      <el-input v-model="currentItem.jdy_app_id"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="简道云 Entry ID" prop="jdy_entry_id">
                      <el-input v-model="currentItem.jdy_entry_id"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-divider>同步模式配置</el-divider>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="同步模式" prop="sync_mode">
                          <el-select v-model="currentItem.sync_mode" placeholder="选择同步模式">
                            <el-option label="INCREMENTAL (增量)" value="INCREMENTAL"></el-option>
                            <el-option label="FULL_REPLACE (全量覆盖)" value="FULL_REPLACE"></el-option>
                            <el-option label="BINLOG (实时)" value="BINLOG"></el-option>
                          </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                         <el-form-item label="任务激活">
                           <el-switch v-model="currentItem.is_active"></el-switch>
                         </el-form-item>
                    </el-col>
                </el-row>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="增量时间字段" prop="incremental_field">
                        <el-input v-model="currentItem.incremental_field" placeholder="e.g., last_modified_time"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="增量间隔 (分钟)" prop="incremental_interval">
                        <el-input-number v-model="currentItem.incremental_interval" :min="1" style="width: 100%;"></el-input-number>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'FULL_REPLACE'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="每日同步时间" prop="full_replace_time">
                         <el-time-picker v-model="currentItem.full_replace_time_temp" format="HH:mm" value-format="HH:mm:ss"
                                        placeholder="选择时间"></el-time-picker>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'FULL_REPLACE'">
                   <el-form-item label="SQL 过滤条件 (选填)" prop="source_filter_sql">
                      <el-input type="textarea" v-model="currentItem.source_filter_sql" placeholder="e.g., status = 'approved' AND amount > 1000"></el-input>
                   </el-form-item>
                 </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'BINLOG'">
                   <el-form-item label="首次执行全量同步 (推荐)">
                      <el-switch v-model="currentItem.is_full_replace_first"></el-switch>
                   </el-form-item>
                </template>

                <el-divider>通知配置</el-divider>

                 <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="发送企微错误日志">
                       <el-switch v-model="currentItem.send_error_log_to_wecom"></el-switch>
                     </el-form-item>
                   </el-col>
                 </el-row>
                 <el-form-item label="企微机器人 Webhook URL" prop="wecom_robot_webhook_url"
                               v-if="currentItem.send_error_log_to_wecom">
                   <el-input type="textarea" v-model="currentItem.wecom_robot_webhook_url"
                             placeholder="如果打开了企微错误通知，请粘贴机器人 URL"></el-input>
                 </el-form-item>

              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // (新) 适配 SyncTask 模型的字段
            const defaultTask = {
                task_name: '',
                department_id: null,
                source_db_id: null, // (新)
                source_table: '',
                pk_field_names: '',
                jdy_app_id: '',
                jdy_entry_id: '',
                sync_mode: 'INCREMENTAL',
                is_active: true,
                incremental_field: '',
                incremental_interval: 5,
                full_replace_time_temp: null,
                full_replace_time: null,
                source_filter_sql: null,
                is_full_replace_first: true,
                send_error_log_to_wecom: false,
                wecom_robot_webhook_url: null
            };

            const crud = useCrud('/sync-tasks', '同步任务', defaultTask, 'task_id');
            const departments = ref([]);
            const tenantDatabases = ref([]); // (新) 存储所有数据库

            // (新) 计算属性，用于根据选择的部门过滤数据库下拉框
            const filteredDatabases = computed(() => {
                if (props.isSuperuser) {
                    if (!crud.currentItem.department_id) return []; // 管理员必须先选部门
                    return tenantDatabases.value.filter(db => db.department_id === crud.currentItem.department_id);
                }
                return tenantDatabases.value; // 普通租户直接显示 (后端已过滤)
            });

            // (新)
            const onDepartmentChange = () => {
                // 管理员切换部门时，清空已选的数据库
                if (props.isSuperuser) {
                    crud.currentItem.source_db_id = null;
                }
            };

            // (新) 获取部门 (仅管理员)
            const fetchDepartments = async () => {
                if (props.isSuperuser) {
                    try { departments.value = (await apiClient.get('/departments')).data; } catch (e) { console.error(e); }
                }
            };

            // (新) 获取数据库 (所有人)
            const fetchTenantDatabases = async () => {
                try {
                    // /api/tenant-databases 后端会根据用户权限自动过滤
                    tenantDatabases.value = (await apiClient.get('/tenant-databases')).data;
                } catch (error) {
                    console.error("获取数据库列表失败:", error);
                }
            };

            const taskRules = {
                task_name: [{required: true, message: '请输入任务名称', trigger: 'blur'}],
                department_id: [{required: props.isSuperuser, message: '请选择所属部门', trigger: 'change'}],
                source_db_id: [{required: true, message: '请选择源数据库', trigger: 'change'}], // (新)
                source_table: [{required: true, message: '请输入源表名', trigger: 'blur'}],
                pk_field_names: [{required: true, message: '请输入源表主键', trigger: 'blur'}],
                jdy_app_id: [{required: true, message: '请输入 App ID', trigger: 'blur'}],
                jdy_entry_id: [{required: true, message: '请输入 Entry ID', trigger: 'blur'}],
                // ... (其他规则与原文件相同)
            };

            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const statusType = (status) => status === 'running' ? 'primary' : (status === 'error' ? 'danger' : 'info');

            // (新)
            watch(() => crud.dialogVisible.value, (newVal) => {
                if (newVal) {
                    // (新) 打开弹窗时，确保数据库列表已加载
                    fetchTenantDatabases();
                    if (props.isSuperuser) fetchDepartments();

                    // (原) 处理时间回显
                    if (crud.isEdit.value && crud.currentItem.full_replace_time) {
                        crud.currentItem.full_replace_time_temp = crud.currentItem.full_replace_time;
                    } else if (newVal && !crud.isEdit.value) {
                        crud.currentItem.full_replace_time_temp = null;
                        // (新) 非管理员自动设置部门ID
                        if (!props.isSuperuser) {
                            crud.currentItem.department_id = parseInt(localStorage.getItem('department_id'));
                        }
                    }
                }
            });

            return {
                ...crud,
                taskRules,
                departments,
                tenantDatabases,
                filteredDatabases,
                onDepartmentChange,
                formatDateTime,
                statusType,
                ElementPlusIcons
            };
        }
    };

    // --- (修改) SyncLog Component (适配多租户) ---
    const SyncLogView = {
        props: ['isSuperuser'],
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>错误日志查看</span>
                <el-button @click="fetchItems" :icon="ElementPlusIcons.Refresh" :loading="loading">刷新</el-button>
              </div>
            </template>
            <el-form :inline="true" :model="filters" class="log-filter-form">
              <el-form-item label="时间范围">
                <el-date-picker v-model="filters.dateRange" type="datetimerange" range-separator="至"
                                start-placeholder="开始日期" end-placeholder="结束日期"
                                value-format="YYYY-MM-DDTHH:mm:ss"
                                :default-time="[new Date(2000, 1, 1, 0, 0, 0), new Date(2000, 2, 1, 23, 59, 59)]"/>
              </el-form-item>
              <el-form-item label="部门ID" v-if="isSuperuser">
                <el-input v-model.number="filters.departmentIdFilter" placeholder="部门ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item label="任务ID">
                <el-input v-model.number="filters.taskIdFilter" placeholder="任务ID (数字)" clearable></el-input>
              </el-form-item>
              <el-form-item>
                <el-button @click="clearFilters" :icon="ElementPlusIcons.CircleClose">清空筛选</el-button>
              </el-form-item>
            </el-form>
            <el-table :data="filteredLogs" v-loading="loading" style="width: 100%" height="calc(100vh - 270px)">
              <el-table-column type="expand">
                <template #default="props">
                  <div style="padding: 10px; background-color: #f9f9f9;"><p><strong>Traceback:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ props.row.traceback || 'N/A' }}</pre>
                    <p><strong>Payload:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;">{{ formatPayload(props.row.payload) }}</pre>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="id" label="ID" width="70"></el-table-column>
              <el-table-column prop="timestamp" label="时间" width="170" sortable>
                <template #default="scope">{{ formatDateTime(scope.row.timestamp) }}</template>
              </el-table-column>
              <el-table-column prop="department_id" label="部门ID" width="100" v-if="isSuperuser" sortable></el-table-column>
              <el-table-column prop="task_id" label="任务ID" width="100" sortable></el-table-column>
              <el-table-column prop="table_name" label="表名" width="150" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID" width="120"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID" width="120"></el-table-column>
              <el-table-column prop="error_message" label="错误信息" min-width="250">
                <template #default="scope"> <div style="white-space: pre-wrap;">{{ scope.row.error_message }}</div> </template>
              </el-table-column>
            </el-table>
          </el-card>
        `,
        props: ['isSuperuser'],
        setup(props) {
            // (新) API 适配
            const {items, loading, fetchItems} = useCrud('/error-logs', '日志');

            // (新) 适配多租户
            const filters = reactive({dateRange: null, departmentIdFilter: '', taskIdFilter: ''});

            const filteredLogs = computed(() => {
                let logs = items.value;
                if (filters.dateRange?.length === 2) {
                    const [start, end] = [new Date(filters.dateRange[0]).getTime(), new Date(filters.dateRange[1]).getTime()];
                    logs = logs.filter(log => {
                        const t = new Date(log.timestamp).getTime();
                        return t >= start && t <= end;
                    });
                }
                // (新) 适配多租户
                if (props.isSuperuser && filters.departmentIdFilter) {
                    logs = logs.filter(log => log.department_id === filters.departmentIdFilter);
                }
                if (filters.taskIdFilter) {
                    logs = logs.filter(log => log.task_id === filters.taskIdFilter);
                }
                return logs;
            });
            const clearFilters = () => {
                filters.dateRange = null;
                filters.departmentIdFilter = '';
                filters.taskIdFilter = '';
            };
            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const formatPayload = (payloadStr) => {
                if (!payloadStr) return 'N/A';
                try { return JSON.stringify(JSON.parse(payloadStr), null, 2); } catch (e) { return payloadStr; }
            };
            return { items, loading, fetchItems, filters, filteredLogs, clearFilters, formatDateTime, formatPayload, ElementPlusIcons };
        }
    };

    // --- (新) Router Setup (适配多租户) ---
    const routes = [
        {path: '/', redirect: '/sync-tasks'},
        {path: '/departments', component: DepartmentView},
        {path: '/users', component: UserView},
        {path: '/databases', component: DatabaseView},
        {path: '/jdy-keys', component: JdyKeyInfoView},
        {path: '/sync-tasks', component: SyncTaskView},
        {path: '/error-logs', component: SyncLogView}
    ];
    const router = VueRouter.createRouter({history: VueRouter.createWebHashHistory(), routes});

    // --- (新) App Setup (适配 JWT) ---
    const app = createApp({
        setup() {
            const isAuthenticated = ref(false);
            const username = ref('');
            const isSuperuser = ref(false);
            const departmentName = ref('');

            const route = useRoute();
            const routerInstance = useRouter();

            // (新) 检查 localStorage
            const checkAuthentication = () => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    isAuthenticated.value = true;
                    username.value = localStorage.getItem('username') || '';
                    isSuperuser.value = localStorage.getItem('is_superuser') === 'true';
                    departmentName.value = localStorage.getItem('department_name') || 'N/A';
                } else {
                    isAuthenticated.value = false;
                }
            };

            // (新) 登录成功处理器
            const handleLoginSuccess = (userData) => {
                isAuthenticated.value = true;
                username.value = userData.username;
                isSuperuser.value = userData.is_superuser;
                departmentName.value = userData.department_name || 'N/A';
                routerInstance.push('/');
            };

            // (新) 登出处理器
            const handleLogout = async (force = false) => {
                if (!force) {
                    try {
                        // (新) 调用 /api/logout (DELETE) 来吊销Token
                        await apiClient.delete('/logout');
                    } catch (error) {
                        console.error("Logout failed, proceeding with client-side cleanup:", error);
                    }
                }

                // (新) 清理 localStorage
                localStorage.clear();
                isAuthenticated.value = false;
                username.value = '';
                isSuperuser.value = false;
                departmentName.value = '';

                if (!force) {
                    ElMessage.info('已退出登录。');
                }
            };

            const activeMenu = computed(() => route.path);

            onMounted(checkAuthentication); // (新) 启动时检查

            // (新) 将登出函数暴露给拦截器
            window.appInstance = {handleLogout};

            return {
                isAuthenticated,
                username,
                isSuperuser,
                departmentName,
                activeMenu,
                handleLoginSuccess,
                logout: handleLogout, // 暴露给模板
                zhCn: ElementPlusLocaleZhCn.default
            };
        }
    });

    // Register components globally
    app.component('login-view', LoginView);
    // (新) 注册新组件
    app.component('DepartmentView', DepartmentView);
    app.component('UserView', UserView);
    app.component('DatabaseView', DatabaseView);
    app.component('JdyKeyInfoView', JdyKeyInfoView);
    app.component('SyncTaskView', SyncTaskView);
    app.component('SyncLogView', SyncLogView);

    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component)
    }
    app.use(router);
    app.use(ElementPlus, {locale: ElementPlusLocaleZhCn.default});
    app.mount('#app');
</script>
</body>
</html>