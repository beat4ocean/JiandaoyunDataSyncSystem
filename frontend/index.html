<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL 同步至简道云配置</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css"/>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; background-color: #f4f4f5; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .login-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background-color: #f4f4f5; }
        .login-card { width: 400px; padding: 40px 30px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0, 0, 0, .1); background-color: #fff; text-align: center; }
        .login-title { font-size: 24px; font-weight: bold; color: #303133; margin-bottom: 25px; }
        .login-card h2 { font-size: 18px; color: #606266; margin-top: 0; margin-bottom: 20px; }
        .app-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: #fff; }
        .full-height-container { flex-grow: 1; display: flex; overflow: hidden; }
        .el-main { padding: 0; flex-grow: 1; overflow-y: auto; background-color: #f4f4f5; }
        .el-header { background-color: #409eff; color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; }
        .el-menu { border-right: none; }
        .el-menu-item.is-active { background-color: #ecf5ff; }
        .config-card { margin: 20px; }
        .form-dialog .el-input, .form-dialog .el-select, .form-dialog .el-time-picker { width: 100%; }
        .form-dialog .el-form-item { margin-bottom: 15px; }
        .el-table .cell { white-space: pre-wrap; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .el-aside { flex-shrink: 0; background-color: #fff; border-right: 1px solid #eee; padding-top: 10px; }
        .log-filter-form { padding: 15px 0 0 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .log-filter-form .el-form-item { margin-bottom: 0; }
        .visibility-toggle-btn { margin-left: 8px; }
        .form-item-note { font-size: 12px; color: #909399; margin-top: -5px; line-height: 1.2; }
    </style>
</head>
<body>
<div id="app">
    <el-config-provider :locale="zhCn">
        <template v-if="!isAuthenticated">
            <div class="login-container">
                <login-view @login-success="handleLoginSuccess"></login-view>
            </div>
        </template>
        <template v-else>
            <div class="app-container">
                <el-header height="60px">
                    <h2>MySQL 同步至简道云配置</h2>
                    <div>
                        <span>你好, {{ username }}</span>
                        <el-button type="danger" link @click="logout" style="margin-left: 15px;">退出登录</el-button>
                    </div>
                </el-header>
                <el-container class="full-height-container">
                    <el-aside width="200px">
                        <el-menu :default-active="activeMenu" router>
                            <el-menu-item index="/jdy-keys">
                                <el-icon><Key/></el-icon>
                                <span>密钥管理</span>
                            </el-menu-item>
                            <el-menu-item index="/sync-tasks">
                                <el-icon><Tickets/></el-icon>
                                <span>同步任务</span>
                            </el-menu-item>
                            <el-menu-item index="/sync-logs">
                                <el-icon><Document/></el-icon>
                                <span>错误日志</span>
                            </el-menu-item>
                        </el-menu>
                    </el-aside>
                    <el-main>
                        <router-view></router-view>
                    </el-main>
                </el-container>
            </div>
        </template>
    </el-config-provider>
</div>

<script>
    const ElementPlusIcons = window.ElementPlusIconsVue || {};
    const {createApp, ref, reactive, computed, onMounted, watch} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;
    const {useRoute, useRouter} = VueRouter;

    // --- Axios Instance ---
    const apiClient = axios.create({baseURL: '/', withCredentials: true});
    apiClient.interceptors.request.use(config => {
        const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrf_access_token='));
        if (csrfToken && ['POST', 'PUT', 'DELETE'].includes(config.method.toUpperCase())) {
            config.headers['X-CSRF-TOKEN'] = csrfToken.split('=')[1];
        }
        return config;
    });

    apiClient.interceptors.response.use(
        response => response,
        error => {
            if (error.response?.status === 401) {
                window.appInstance?.handleLogout();
                ElMessage.error('会话已过期，请重新登录。');
            } else if (error.response?.data?.error) {
                ElMessage.error(`操作失败: ${error.response.data.error}`);
            } else if (error.response?.data?.msg) {
                 ElMessage.error(`操作失败: ${error.response.data.msg}`);
            } else if (error.message) {
                ElMessage.error(`请求错误: ${error.message}`);
            } else {
                ElMessage.error('发生未知错误');
            }
            return Promise.reject(error);
        }
    );

    // --- Reusable CRUD Composable ---
    function useCrud(apiEndpoint, itemName = '项目', defaultItem = {}) {
        const items = ref([]);
        const loading = ref(false);
        const dialogVisible = ref(false);
        const isEdit = ref(false);
        const currentItem = reactive({});
        const formRef = ref(null);

        const fetchItems = async () => {
            loading.value = true;
            try {
                const response = await apiClient.get(apiEndpoint);
                items.value = response.data;
            } catch (error) {
                console.error(`获取 ${itemName} 列表失败:`, error);
            } finally {
                loading.value = false;
            }
        };

        const openDialog = (item = null) => {
            if (item) {
                isEdit.value = true;
                Object.assign(currentItem, JSON.parse(JSON.stringify(item)));
            } else {
                isEdit.value = false;
                Object.keys(currentItem).forEach(key => delete currentItem[key]);
                Object.assign(currentItem, JSON.parse(JSON.stringify(defaultItem)));
            }
            dialogVisible.value = true;
            Vue.nextTick(() => {
                if (formRef.value) formRef.value.clearValidate();
            });
        };

        const closeDialog = () => {
            dialogVisible.value = false;
        };

        const saveItem = async () => {
            if (!formRef.value) return;
            try {
                await formRef.value.validate();
            } catch (error) {
                ElMessage.warning('请检查表单输入。');
                return;
            }

            loading.value = true;
            const url = isEdit.value ? `${apiEndpoint}/${currentItem.task_id || currentItem.id}` : apiEndpoint;
            const method = isEdit.value ? 'put' : 'post';
            try {
                const dataToSend = {...currentItem};
                // 转换布尔值
                if ('is_active' in dataToSend) dataToSend.is_active = !!dataToSend.is_active;
                if ('is_full_replace_first' in dataToSend) dataToSend.is_full_replace_first = !!dataToSend.is_full_replace_first;
                if ('send_error_log_to_wecom' in dataToSend) dataToSend.send_error_log_to_wecom = !!dataToSend.send_error_log_to_wecom;

                // 处理时间字段
                if ('full_replace_time_temp' in dataToSend) {
                    dataToSend.full_replace_time = dataToSend.full_replace_time_temp || null;
                    delete dataToSend.full_replace_time_temp;
                }

                const response = await apiClient[method](url, dataToSend);
                const idKey = currentItem.task_id ? 'task_id' : 'id';
                if (isEdit.value) {
                    const index = items.value.findIndex(i => i[idKey] === currentItem[idKey]);
                    if (index !== -1) items.value.splice(index, 1, response.data);
                } else {
                    items.value.push(response.data);
                }
                closeDialog();
                ElMessage.success(`${itemName} 保存成功！`);
            } catch (error) {
                console.error(`保存 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };

        const deleteItem = async (id) => {
            try {
                await ElMessageBox.confirm(`确定要删除这个 ${itemName} (ID: ${id}) 吗?`, '警告', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                });
                loading.value = true;
                await apiClient.delete(`${apiEndpoint}/${id}`);
                const idKey = items.value.length > 0 && items.value[0].task_id ? 'task_id' : 'id';
                items.value = items.value.filter(i => i[idKey] !== id);
                ElMessage.success(`${itemName} 删除成功！`);
            } catch (error) {
                if (error !== 'cancel') console.error(`删除 ${itemName} 失败:`, error);
            } finally {
                loading.value = false;
            }
        };
        onMounted(fetchItems);
        return { items, loading, dialogVisible, isEdit, currentItem, formRef, fetchItems, openDialog, closeDialog, saveItem, deleteItem };
    }

    // --- Login Component ---
    const LoginView = {
        template: `
          <el-card class="login-card">
            <h1 class="login-title">MySQL 数据同步系统</h1>
            <h2>登录</h2>
            <el-form @submit.prevent="submitLogin" ref="loginFormRef" :model="loginForm" :rules="loginRules" label-position="top">
              <el-form-item label="用户名" prop="username">
                <el-input v-model="loginForm.username" placeholder="请输入用户名"></el-input>
              </el-form-item>
              <el-form-item label="密码" prop="password">
                <el-input type="password" v-model="loginForm.password" placeholder="请输入密码" show-password></el-input>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" native-type="submit" :loading="loading" style="width: 100%;">登录</el-button>
              </el-form-item>
            </el-form>
          </el-card>
        `,
        emits: ['login-success'],
        setup(props, {emit}) {
            const loginForm = reactive({username: '', password: ''});
            const loading = ref(false);
            const loginFormRef = ref(null);
            const loginRules = {
                username: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: true, message: '请输入密码', trigger: 'blur'}],
            };
            const submitLogin = async () => {
                if (!loginFormRef.value) return;
                try { await loginFormRef.value.validate(); } catch (error) { return; }
                loading.value = true;
                try {
                    await apiClient.post('/auth/login', loginForm);
                    emit('login-success', loginForm.username);
                    ElMessage.success('登录成功!');
                } catch (error) {
                    console.error("登录失败:", error);
                } finally {
                    loading.value = false;
                }
            };
            return {loginForm, loading, loginFormRef, loginRules, submitLogin};
        }
    };

    // --- JdyKeyInfo Component ---
    const JdyKeyInfoView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>密钥管理 (部门)</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加密钥</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%">
              <el-table-column prop="id" label="ID" width="80"></el-table-column>
              <el-table-column prop="department_name" label="部门名称 (英文)" sortable></el-table-column>
              <el-table-column label="API Key">
                <template #default="scope"> {{ visibleKeys[scope.row.id] ? scope.row.api_key : '******' }}</template>
              </el-table-column>
              <el-table-column label="操作" width="300" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="toggleVisibility(scope.row.id)" :icon="visibleKeys[scope.row.id] ? ElementPlusIcons.View : ElementPlusIcons.Hide">
                    {{ visibleKeys[scope.row.id] ? '隐藏' : '显示' }}
                  </el-button>
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit" class="visibility-toggle-btn">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.id)" :icon="ElementPlusIcons.Delete" class="visibility-toggle-btn">删除</el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑密钥' : '添加密钥'" width="500px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="keyRules" label-position="top">
                <el-form-item label="部门名称 (英文)" prop="department_name">
                  <el-input v-model="currentItem.department_name" placeholder="例如：sales_dept"></el-input>
                </el-form-item>
                <el-form-item label="API Key" prop="api_key">
                  <el-input v-model="currentItem.api_key" placeholder="请输入简道云 API Key"></el-input>
                </el-form-item>
              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        setup() {
            const crud = useCrud('/api/jdy-keys', '密钥');
            const visibleKeys = reactive({});
            const keyRules = {
                department_name: [{required: true, message: '请输入部门名称', trigger: 'blur'}],
                api_key: [{required: true, message: '请输入 API Key', trigger: 'blur'}],
            };
            const toggleVisibility = (id) => {
                visibleKeys[id] = !visibleKeys[id];
            };
            const originalFetchItems = crud.fetchItems;
            crud.fetchItems = async () => {
                await originalFetchItems();
                crud.items.value.forEach(item => {
                    if (!(item.id in visibleKeys)) visibleKeys[item.id] = false;
                });
            };
            onMounted(crud.fetchItems);
            return {...crud, keyRules, visibleKeys, toggleVisibility, ElementPlusIcons};
        }
    };

    // --- SyncTask Component ---
    const SyncTaskView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>同步任务管理</span>
                <el-button type="primary" @click="openDialog()" :icon="ElementPlusIcons.Plus">添加任务</el-button>
              </div>
            </template>
            <el-table :data="items" v-loading="loading" style="width: 100%" row-key="task_id">
              <el-table-column prop="task_id" label="ID" width="60"></el-table-column>
              <el-table-column prop="task_name" label="任务名称" sortable></el-table-column>
              <el-table-column prop="department_name" label="所属部门" sortable>
                <template #default="scope"> <el-tag>{{ scope.row.department_name }}</el-tag> </template>
              </el-table-column>
              <el-table-column prop="source_table" label="源表名" sortable></el-table-column>
              <el-table-column prop="jdy_app_id" label="App ID"></el-table-column>
              <el-table-column prop="jdy_entry_id" label="Entry ID"></el-table-column>
              <el-table-column prop="sync_mode" label="同步模式" width="130"></el-table-column>
              <el-table-column prop="is_active" label="激活" width="70">
                <template #default="scope">
                  <el-tag :type="scope.row.is_active ? 'success' : 'info'">{{ scope.row.is_active ? '是' : '否' }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="status" label="运行状态" width="100">
                 <template #default="scope">
                  <el-tag :type="statusType(scope.row.status)"> {{ scope.row.status }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="last_sync_time" label="上次同步时间" width="170">
                <template #default="scope">{{ formatDateTime(scope.row.last_sync_time) }}</template>
              </el-table-column>
              <el-table-column label="操作" width="180" fixed="right">
                <template #default="scope">
                  <el-button size="small" @click="openDialog(scope.row)" :icon="ElementPlusIcons.Edit">编辑</el-button>
                  <el-button size="small" type="danger" @click="deleteItem(scope.row.task_id)" :icon="ElementPlusIcons.Delete">删除</el-button>
                </template>
              </el-table-column>
            </el-table>

            <el-dialog v-model="dialogVisible" :title="isEdit ? '编辑任务' : '添加任务'" width="700px" @close="closeDialog" class="form-dialog">
              <el-form ref="formRef" :model="currentItem" :rules="taskRules" label-position="top" label-width="150px">

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="任务名称" prop="task_name">
                      <el-input v-model="currentItem.task_name" placeholder="例如：销售订单同步"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                     <el-form-item label="所属部门 (密钥)" prop="department_name">
                      <el-select v-model="currentItem.department_name" placeholder="选择关联的密钥部门">
                        <el-option v-for="keyInfo in jdyKeyInfos" :key="keyInfo.department_name"
                                   :label="keyInfo.department_name" :value="keyInfo.department_name"></el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="源数据库表名" prop="source_table">
                      <el-input v-model="currentItem.source_table" placeholder="数据库中的表名或视图名"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="源表主键" prop="pk_field_names">
                      <el-input v-model="currentItem.pk_field_names" placeholder="e.g., id (复合主键用逗号分隔)"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="简道云 App ID" prop="jdy_app_id">
                      <el-input v-model="currentItem.jdy_app_id"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="简道云 Entry ID" prop="jdy_entry_id">
                      <el-input v-model="currentItem.jdy_entry_id"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-divider>同步模式配置</el-divider>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="同步模式" prop="sync_mode">
                          <el-select v-model="currentItem.sync_mode" placeholder="选择同步模式">
                            <el-option label="INCREMENTAL (增量)" value="INCREMENTAL"></el-option>
                            <el-option label="FULL_REPLACE (全量覆盖)" value="FULL_REPLACE"></el-option>
                            <el-option label="BINLOG (实时)" value="BINLOG"></el-option>
                          </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                         <el-form-item label="任务激活">
                           <el-switch v-model="currentItem.is_active"></el-switch>
                         </el-form-item>
                    </el-col>
                </el-row>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="增量时间字段" prop="incremental_field">
                        <el-input v-model="currentItem.incremental_field" placeholder="e.g., last_modified_time"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="增量间隔 (分钟)" prop="incremental_interval">
                        <el-input-number v-model="currentItem.incremental_interval" :min="1" style="width: 100%;"></el-input-number>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'FULL_REPLACE'">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="每日同步时间" prop="full_replace_time">
                         <el-time-picker v-model="currentItem.full_replace_time_temp" format="HH:mm" value-format="HH:mm:ss"
                                        placeholder="选择时间"></el-time-picker>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'FULL_REPLACE'">
                   <el-form-item label="SQL 过滤条件 (选填)" prop="source_filter_sql">
                      <el-input type="textarea" v-model="currentItem.source_filter_sql" placeholder="e.g., status = 'approved' AND amount > 1000"></el-input>
                   </el-form-item>
                 </template>

                <template v-if="currentItem.sync_mode === 'INCREMENTAL' || currentItem.sync_mode === 'BINLOG'">
                   <el-form-item label="首次执行全量同步 (推荐)">
                      <el-switch v-model="currentItem.is_full_replace_first"></el-switch>
                   </el-form-item>
                </template>

                <el-divider>通知配置</el-divider>

                 <el-row :gutter="20">
                   <el-col :span="12">
                     <el-form-item label="发送企微错误日志">
                       <el-switch v-model="currentItem.send_error_log_to_wecom"></el-switch>
                     </el-form-item>
                   </el-col>
                 </el-row>
                 <el-form-item label="企微机器人 Webhook URL (可选)" prop="wecom_robot_webhook_url"
                               v-if="currentItem.send_error_log_to_wecom">
                   <el-input type="textarea" v-model="currentItem.wecom_robot_webhook_url"
                             placeholder="如果打开了企微错误通知，请粘贴机器人 URL"></el-input>
                 </el-form-item>

              </el-form>
              <template #footer>
                <el-button @click="closeDialog">取消</el-button>
                <el-button type="primary" @click="saveItem" :loading="loading">保存</el-button>
              </template>
            </el-dialog>
          </el-card>
        `,
        setup() {
            const defaultTask = {
                task_name: '',
                department_name: null,
                source_table: '',
                pk_field_names: '',
                jdy_app_id: '',
                jdy_entry_id: '',
                sync_mode: 'INCREMENTAL',
                is_active: true,
                incremental_field: '',
                incremental_interval: 5,
                full_replace_time_temp: null,
                full_replace_time: null,
                source_filter_sql: null,
                is_full_replace_first: true,
                send_error_log_to_wecom: false,
                wecom_robot_webhook_url: null
            };

            const crud = useCrud('/api/sync-tasks', '同步任务', defaultTask);
            const jdyKeyInfos = ref([]);

            const fetchKeyInfos = async () => {
                try {
                    jdyKeyInfos.value = (await apiClient.get('/api/jdy-keys')).data;
                } catch (error) {
                    console.error("获取密钥信息失败:", error);
                }
            };

            const taskRules = {
                task_name: [{required: true, message: '请输入任务名称', trigger: 'blur'}],
                department_name: [{required: true, message: '请选择所属部门', trigger: 'change'}],
                source_table: [{required: true, message: '请输入源表名', trigger: 'blur'}],
                pk_field_names: [{required: true, message: '请输入源表主键', trigger: 'blur'}],
                jdy_app_id: [{required: true, message: '请输入 App ID', trigger: 'blur'}],
                jdy_entry_id: [{required: true, message: '请输入 Entry ID', trigger: 'blur'}],
                sync_mode: [{required: true, message: '请选择同步模式', trigger: 'change'}],
                incremental_field: [{
                    validator: (rule, value, callback) => {
                        if (crud.currentItem.sync_mode === 'INCREMENTAL' && !value) callback(new Error('请输入增量时间字段')); else callback();
                    }, trigger: 'blur'
                }],
                 incremental_interval: [{
                    validator: (rule, value, callback) => {
                        if (crud.currentItem.sync_mode === 'INCREMENTAL' && (!value || value < 1)) callback(new Error('请输入有效的增量间隔')); else callback();
                    }, trigger: 'blur'
                }],
                full_replace_time: [{
                    validator: (rule, value, callback) => {
                         // We validate the temp field before it's copied
                        if (crud.currentItem.sync_mode === 'FULL_REPLACE' && !crud.currentItem.full_replace_time_temp) callback(new Error('请选择每日同步时间')); else callback();
                    }, trigger: 'change'
                }],
                wecom_robot_webhook_url: [{
                    validator: (rule, value, callback) => {
                        if (crud.currentItem.send_error_log_to_wecom && !value) callback(new Error('请输入企微机器人 URL')); else callback();
                    }, trigger: 'blur'
                }]
            };

            const formatTime = (isoTime) => isoTime ? isoTime.substring(0, 5) : '-';
            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const statusType = (status) => status === 'running' ? 'primary' : (status === 'error' ? 'danger' : 'info');

            // 确保编辑时正确加载 full_replace_time 到 time-picker
            watch(() => crud.dialogVisible.value, (newVal) => {
                if (newVal && crud.isEdit.value && crud.currentItem.full_replace_time) {
                    crud.currentItem.full_replace_time_temp = crud.currentItem.full_replace_time;
                } else if (newVal && !crud.isEdit.value) {
                    crud.currentItem.full_replace_time_temp = null;
                }
            });

            onMounted(fetchKeyInfos);

            return {
                ...crud,
                taskRules,
                jdyKeyInfos,
                formatTime,
                formatDateTime,
                statusType,
                ElementPlusIcons
            };
        }
    };

    // --- SyncLog Component ---
    const SyncLogView = {
        template: `
          <el-card class="config-card">
            <template #header>
              <div class="card-header"><span>错误日志查看</span>
                <el-button @click="fetchItems" :icon="ElementPlusIcons.Refresh" :loading="loading">刷新</el-button>
              </div>
            </template>
            <el-form :inline="true" :model="filters" class="log-filter-form">
              <el-form-item label="时间范围">
                <el-date-picker v-model="filters.dateRange" type="datetimerange" range-separator="至"
                                start-placeholder="开始日期" end-placeholder="结束日期"
                                value-format="YYYY-MM-DDTHH:mm:ss"
                                :default-time="[new Date(2000, 1, 1, 0, 0, 0), new Date(2000, 2, 1, 23, 59, 59)]"/>
              </el-form-item>
              <el-form-item label="部门">
                <el-input v-model="filters.departmentFilter" placeholder="部门名称包含" clearable></el-input>
              </el-form-item>
              <el-form-item label="表名/任务">
                <el-input v-model="filters.tableNameFilter" placeholder="表名/任务包含" clearable></el-input>
              </el-form-item>
              <el-form-item>
                <el-button @click="clearFilters" :icon="ElementPlusIcons.CircleClose">清空筛选</el-button>
              </el-form-item>
            </el-form>
            <el-table :data="filteredLogs" v-loading="loading" style="width: 100%" height="calc(100vh - 270px)">
              <el-table-column type="expand">
                <template #default="props">
                  <div style="padding: 10px; background-color: #f9f9f9;"><p><strong>Traceback:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ props.row.traceback || 'N/A' }}</pre>
                    <p><strong>Payload:</strong></p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;">{{ formatPayload(props.row.payload) }}</pre>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="id" label="ID" width="70"></el-table-column>
              <el-table-column prop="timestamp" label="时间" width="170" sortable>
                <template #default="scope">{{ formatDateTime(scope.row.timestamp) }}</template>
              </el-table-column>
              <el-table-column prop="department_name" label="部门" width="120" sortable></el-table-column>
              <el-table-column prop="table_name" label="表名/任务" width="150" sortable></el-table-column>
              <el-table-column prop="app_id" label="App ID" width="120"></el-table-column>
              <el-table-column prop="entry_id" label="Entry ID" width="120"></el-table-column>
              <el-table-column prop="error_message" label="错误信息" min-width="250">
                <template #default="scope"> <div style="white-space: pre-wrap;">{{ scope.row.error_message }}</div> </template>
              </el-table-column>
            </el-table>
          </el-card>
        `,
        setup() {
            const {items, loading, fetchItems} = useCrud('/api/sync-logs', '日志');
            const filters = reactive({dateRange: null, departmentFilter: '', tableNameFilter: ''});
            const filteredLogs = computed(() => {
                let logs = items.value;
                if (filters.dateRange?.length === 2) {
                    const [start, end] = [new Date(filters.dateRange[0]).getTime(), new Date(filters.dateRange[1]).getTime()];
                    logs = logs.filter(log => {
                        const t = new Date(log.timestamp).getTime();
                        return t >= start && t <= end;
                    });
                }
                if (filters.departmentFilter) {
                    const f = filters.departmentFilter.toLowerCase();
                    logs = logs.filter(log => log.department_name?.toLowerCase().includes(f));
                }
                if (filters.tableNameFilter) {
                    const f = filters.tableNameFilter.toLowerCase();
                    logs = logs.filter(log => log.table_name?.toLowerCase().includes(f));
                }
                return logs;
            });
            const clearFilters = () => {
                filters.dateRange = null;
                filters.departmentFilter = '';
                filters.tableNameFilter = '';
            };
            const formatDateTime = (isoDateTime) => isoDateTime ? new Date(isoDateTime).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}) : '-';
            const formatPayload = (payloadStr) => {
                if (!payloadStr) return 'N/A';
                try { return JSON.stringify(JSON.parse(payloadStr), null, 2); } catch (e) { return payloadStr; }
            };
            return { items, loading, fetchItems, filters, filteredLogs, clearFilters, formatDateTime, formatPayload, ElementPlusIcons };
        }
    };

    // --- Router Setup ---
    const routes = [
        {path: '/', redirect: '/sync-tasks'},
        {path: '/jdy-keys', component: JdyKeyInfoView},
        {path: '/sync-tasks', component: SyncTaskView},
        {path: '/sync-logs', component: SyncLogView}
    ];
    const router = VueRouter.createRouter({history: VueRouter.createWebHashHistory(), routes});

    // --- App Setup ---
    const app = createApp({
        setup() {
            const isAuthenticated = ref(false);
            const username = ref('');
            const route = useRoute();
            const routerInstance = useRouter();
            const checkAuthentication = async () => {
                try {
                    const response = await apiClient.get('/auth/check_auth');
                    isAuthenticated.value = true;
                    username.value = response.data.logged_in_as;
                } catch (error) {
                    isAuthenticated.value = false;
                    username.value = '';
                }
            };
            const handleLoginSuccess = (loggedInUsername) => {
                isAuthenticated.value = true;
                username.value = loggedInUsername;
                routerInstance.push('/');
            };
            const handleLogout = async () => {
                try { await apiClient.post('/auth/logout'); } catch (error) { console.error("Logout failed:", error); }
                finally {
                    isAuthenticated.value = false;
                    username.value = '';
                    ElMessage.info('已退出登录。');
                }
            };
            const activeMenu = computed(() => route.path);
            onMounted(checkAuthentication);
            window.appInstance = {handleLogout};
            return {
                isAuthenticated, username, activeMenu, handleLoginSuccess,
                logout: handleLogout,
                zhCn: ElementPlusLocaleZhCn.default
            };
        }
    });

    // Register components globally
    app.component('login-view', LoginView);
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component)
    }
    app.use(router);
    app.use(ElementPlus, {locale: ElementPlusLocaleZhCn.default});
    app.mount('#app');
</script>
</body>
</html>